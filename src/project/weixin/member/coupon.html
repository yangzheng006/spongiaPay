<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>我的优惠券</title>
    @import "../include/header.inc";
</head>
<body ontouchstart>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>


<!--优惠券-->
<link rel="import" href="../../../pages/member/coupon/coupon.html">
<link rel="import" href="../../../pages/member/coupon/platformTicket.html">

<!--模板-->
<link rel="import" href="../../../model/templete/member/coupon/list.html"> <!--优惠券列表模板-->
<link rel="import" href="../../../model/templete/member/coupon/platformList.html"> <!--平台券领取记录模板-->



@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/common.min.js"></script>
<script src="/weixin/js/wap.min.js"></script>

<script type="text/javascript">
    $(function () {
        pageManager.show("coupon");


        if(window.location.hash==''){
            //使用红包
            $('body').on("click", "#user", function () {
                var code = $(this).attr("code");
                var red = new redPacket(function (data) {
                    location.href=location.origin+'/weixin/member/index.html?code='+code+'&tenantName='+escape(data.tenantName)+'#useRedPacket';
                });
                red.use({code: code});
            });
            //加载我的优惠券模板
            var canshu = window.location.search;
            if(canshu.indexOf("?id=")>-1){
                $('.myRedPacket').find('a').attr('href','javascript:location.replace(location.origin+"/weixin/member/redPacket.html?id=' + pageManager.GetQueryString("id") + '")');
                var page = $(".pageable").pageable({
                        loadUpFn:function(me) {
                            var tu = new coupon(function (data) {
                                var h = render.fill($("#tpl_list"),data);
                                $(".pageable .conpon").html(h);
                                me.resetload();
                            });
                            tu.list({pageNumber: 1,tenantId:pageManager.GetQueryString('id')});
                        },
                        loadDownFn :function(me) {
                            var td = new coupon(function (data) {
                                me.pageNumber = me.pageNumber +1;
                                var h = render.fill($("#tpl_list"),data);
                                $(".pageable .conpon").append(h);
                                if (data.length<20){
                                    me.lock();
                                    me.noData();
                                }
                                me.resetload();
                            });
                            td.list({pageNumber: me.pageNumber,tenantId:pageManager.GetQueryString('id')});
                        }
                    }
                );
            }else{
                var page = $(".pageable").pageable({
                        loadUpFn:function(me) {
                            var tu = new coupon(function (data) {
                                var h = render.fill($("#tpl_list"),data);
                                $(".pageable .conpon").html(h);
                                me.resetload();
                            });
                            tu.list({pageNumber: 1});
                        },
                        loadDownFn :function(me) {
                            var td = new coupon(function (data) {
                                me.pageNumber = me.pageNumber +1;
                                var h = render.fill($("#tpl_list"),data);
                                $(".pageable .conpon").append(h);
                                if (data.length<20){
                                    me.lock();
                                    me.noData();
                                }
                                me.resetload();
                            });
                            td.list({pageNumber: me.pageNumber});
                        }
                    }
                );
            }
        }


        if(window.location.hash=='#platformTicket'){
            document.title='平台券领取记录';
            //加载列表
            var pges = $(".pageable").pageable({
                loadUpFn:function(me) {
                    var tu = new coupon(function (data) {
                        var h = render.fill($("#tpl_platformList"),data);
                        $(".pageable .ticket").html(h);
                        //me.noData(false);
                        me.resetload();
                    });
                    tu.record({pageNumber:1,id: pageManager.GetQueryString("id")});
                },
                loadDownFn :function(me) {
                    var td = new coupon(function (data) {
                        me.pageNumber = me.pageNumber +1;
                        var h = render.fill($("#tpl_platformList"),data);
                        $(".pageable .ticket").append(h);
                        if (data.length<20){
                            me.lock();
                            me.noData();
                        }
                        me.resetload();
                    });
                    td.record({pageNumber: me.pageNumber,id: pageManager.GetQueryString("id")});
                }
            });
        }

    });
</script>
</body>
</html>

