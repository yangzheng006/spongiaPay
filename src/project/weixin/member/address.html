<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>我的地址</title>
    @import "../include/header.inc";
    <link rel="stylesheet" href="/weixin/style/member.min.css"/>
</head>
<body ontouchstart onpageshow="reloadAddress()">
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>

<!--我的地址-->
<link rel="import" href="../../../pages/member/address/listAddress.html">
<link rel="import" href="../../../pages/member/address/addAddress.html">
<link rel="import" href="../../../pages/member/address/editAddress.html">
<!--地址列表-->
<link rel="import" href="../../../model/templete/member/address/list.html">
@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/common.min.js"></script>
<script src="/weixin/js/wap.min.js"></script>
<script type="text/javascript">

    function reloadAddress() {

        setTimeout(function () {

        },50)
    }


    $(function () {


        pageManager.show("listAddress");


        //编辑地址
        if(window.location.hash=='#editAddress'){
            document.title='编辑地址';
            hiddenBtn.bind();
            var id=pageManager.GetQueryString('id');
            var re=new receiver(function(data){
                $("#consignee").val(data.consignee);
                $("#myarea").html(data.area.fullName);
                $("#myarea").attr('area-id',data.area.id);
                $("#address").val(data.address);
                $("#phone").val(data.phone);
            });
            re.view({id:id});
            //添加地址选择区域
            $("#changeArea").click(function () {
                $('.icon-quxiao1').css('top','8vh');
                $('.weui-mask').removeClass('none');
                $('.icon-quxiao1').removeClass('none');
                $('.weui-mask,.icon-quxiao1').on('click',function () {
                    $('.chooseWidget').hide();
                    $('.weui-mask').addClass('none');
                    $('.icon-quxiao1').addClass('none');
                });
                choose.area();
                choose.callBack=function (area) {
                    $("#myarea").text(area.fullName);
                    $("#myarea").attr('area-id',area.id); //绑定区域id
                    $('.weui-mask').addClass('none');
                    $('.icon-quxiao1').addClass('none');
                };
            });
            //保存修改好的地址
            $("#saveadd").click(function(){
                var area_id=$("#myarea").attr('area-id');
                var consignee=$("#consignee").val();
                var address=$("#address").val();
                var phone=$("#phone").val();
                var re=new receiver(function(data){
                    console.log(data);
                    toast.show("修改成功");
                    setTimeout(function () {
                        pageManager.back();
                    },1000);
                });
                re.update({id:id,areaId:area_id,consignee:consignee,address:address,phone:phone});
            });
        }

    });
    var pageFn = function(){


        if(pageManager._getHash()=='#'){
            //读取地址列表
            var td = new receiver(function (data) {
                var h = render.fill($("#tpl_list"),data);
                var listLength=data.length;
                $(".pageable .addressSwipper").html(h);

                //删除收货地址
                $(".deletead").click(function(){
                    var ad_id=$(this).parent().parent().attr('ad-id');
                    dialog.query("您确认删除该地址吗？",function () {
                        var re=new receiver(function(data){
                            console.log(data);
                            toast.show("删除成功");
                            setTimeout(function () {
                                location.reload();
                            },500);
                        });
                        re.delete({id:ad_id});
                    });
                });
                //设为默认地址
                $("label").click(function(){
                    var ad_id=$(this).parent().attr('ad-id');
                    var re=new receiver(function(data){
                        console.log(data);
                        toast.show("设置成功");
                        setTimeout(function () {
                            location.reload();
                        },200);
                    });
                    re.setDefault({id:ad_id});
                });
                var $firstDefalut=$('.weui-cells').first();
                var id=$firstDefalut.attr('ad-id');
                var r=new receiver(function (data) {
                    console.log(data);
                    $('.weui-cells').first().find('.ifcheck').prop('checked',true);
                });
                r.setDefault({id:id});
                var ad_id;
                //点击编辑地址
                $(".editad").click(function(){
                    ad_id=$(this).parent().parent().attr('ad-id');
                    var re=new receiver(function(data){
                        console.log(data.area.id);
                        location.href=location.origin+'/weixin/member/address.html?id='+ad_id+'#editAddress';
                    });
                    re.view({id:ad_id});
                });

                $('.addAddressNow').click(function(){
                    if(listLength>=8) {
                        toast.show('最多添加8个地址');
                    }else{
                        if(pageManager.GetQueryString('type')=='cart'){
                            pageManager.replace('addAddress');
                        }else{
                            pageManager.go('addAddress');
                        }
                    }
                });
            });
            td.list({pageNumber:1});
        }

        //添加地址
        if(window.location.hash=='#addAddress'){
            document.title='添加地址';
            hiddenBtn.bind();
            weixin.location(function (flag) {
                if(flag){
                    new lbs(function (data) {
                        $("#myarea").text(data.bd_area.fullName);
                        $("#myarea").attr('area-id',data.bd_area.id); //绑定区域id
                        $("#address").val(data.area.sematic_description);
                    }).get({
                        lat:weixin.lat,
                        lng:weixin.lng
                    });
                }
            });
            //添加地址选择区域
            $("#changeArea").click(function () {
                $('.icon-quxiao1').css('top','8vh');
                $('.weui-mask').removeClass('none');
                $('.icon-quxiao1').removeClass('none');
                $('.weui-mask,.icon-quxiao1').on('click',function () {
                    $('.chooseWidget').hide();
                    $('.weui-mask').addClass('none');
                    $('.icon-quxiao1').addClass('none');
                });
                choose.area();
                choose.callBack=function (area) {
                    $("#myarea").text(area.fullName);
                    $("#myarea").attr('area-id',area.id); //绑定区域id
                    $('.weui-mask').addClass('none');
                    $('.icon-quxiao1').addClass('none');
                };
            });
            var where=pageManager.GetQueryString('type');
            //保存地址
            $("#saveadd").click(function(){
                var consignee=$("#consignee").val();
                var phone=$("#phone").val();
                var address=$("#address").val();
                var areaId=$("#myarea").attr('area-id');
                if(consignee==""){
                    dialog.show("请输入收货人姓名！")
                }else if((!(/^1[34578]\d{9}$/.test(phone)))){
                    dialog.show("请输正确手机号码！")
                }else if($("#myarea").val()==''){
                    dialog.show("请选择收货地址！")
                }else{
                    var re=new receiver(function(data){
                        console.log(data);
                        if(where=='cart'){
                            setTimeout(function(){
                                location.replace('../cart/index.html#orderPay');
                            },1000);
                        }else{
                            setTimeout(function(){
                                history.back();
                            },1000);
                        }
                    });
                    re.save({
                        consignee:consignee,
                        phone:phone,
                        address:address,
                        areaId:areaId,
                        "location.lat":weixin.lat,
                        "location.lng":weixin.lng
                    });
                }
            });
        }
    }
    window.addEventListener('pageGoOk',pageFn)
</script>
</body>
</html>

