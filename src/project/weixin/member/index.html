<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>个人中心</title>
    @import "../include/header.inc";
    <link rel="stylesheet" href="/weixin/style/wap.min.css"/>
</head>

<body>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>

<!--会员首页-->
<link rel="import" href="../../../pages/member/index.html">
<!--设置-->
<link rel="import" href="../../../pages/member/setting/setting.html">
<link rel="import" href="../../../pages/member/setting/changeBind.html">
<!--认证商家-->
<link rel="import" href="../../../pages/member/authTenant.html">
<!--积分-->
<link rel="import" href="../../../pages/member/point/cashPoint.html">
<link rel="import" href="../../../pages/member/point/cashSuccess.html">
<link rel="import" href="../../../pages/member/point/givePoint.html">
<link rel="import" href="../../../pages/member/point/listPoint.html">
<link rel="import" href="../../../pages/member/point/usePoint.html">
<!--添加銀行卡-->
<link rel="import" href="../../../pages/member/bankCard/bankList.html">
<!--添加银行卡-->
<link rel="import" href="../../../pages/member/bankCard/cardOne.html">
<link rel="import" href="../../../pages/member/bankCard/cardThree.html">
<!--邀请好友-->
<link rel="import" href="../../../pages/member/invite/invite.html">
<link rel="import" href="../../../pages/member/invite/inviteSuccess.html">
<!-- 历史推荐 -->
<link rel="import" href="../../../pages/member/recommend/historyRecommend.html">
<!--帮助中心-->
<link rel="import" href="../../../pages/member/help/help.html">
<link rel="import" href="../../../pages/member/help/helpView.html">
<!--关于我们-->
<link rel="import" href="../../../pages/member/aboutUs.html">
<!--绑定手机与实名认证-->
<link rel="import" href="../../../pages/member/bind.html">
<!--绑定手机-->
<link rel="import" href="../../../pages/member/auth.html">
<!--实名认证-->
<!--个人信息-->
<link rel="import" href="../../../pages/member/info/tenantInfo.html">
<!--商家信息-->
<link rel="import" href="../../../pages/member/info/userInfo.html">


<link rel="import" href="../../../model/templete/member/helpList.html">
<!--银行卡列表-->
<link rel="import" href="../../../model/templete/member/bankCardList.html">
<link rel="import" href="../../../model/templete/member/point/pointListTpl.html">
<!-- 历史推荐 -->
<link rel="import" href="../../../model/templete/member/recommendList.html">
<link rel="import" href="../../../model/templete/member/recommendTenantList.html">
@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/common.min.js"></script>
<script src="/weixin/js/wap.min.js"></script>
<script type="text/javascript">
    window.onpageshow = function (ev) {
        if (pageManager._getHash() == '#orderList') {
            if (ev.persisted && WeixinJSBridge) {
                window.location.reload()
            }
        }
    };
    var pget;
    $(function () {
        pageManager.show("index");
    })

    function uploadImg(files, type, callback) {
        if (files.length === 0) {
            return false;
        }
        toast.loadingSelf(1000000, '压缩上传中');
        compressImg(files[0], function (file) {
            new common(function (data) {
                callback && callback(data, file)
            }).uploadImage({
                image: file.substring(file.indexOf(",") + 1),
                type: type
            })
        })
    }

    var pageFn = function () {
        //个人中心页面
        if (pageManager._getHash() == '#') {
            document.title = '个人中心';
            new member(function (data) {
                console.log(data);
                //认证情况(显示文字)
                $('.memberIndex #username1').html(data.XM)
                if (!data.IsAuthenticationSh && !data.IsAuthenticationSm) {
                    $('.memberIndex .tenantV').addClass('none');
                    $('.memberIndex .userV').removeClass('none');
                    $('.memberIndex .userV span').html('未认证')
                } else if (!data.IsAuthenticationSh && data.IsAuthenticationSm) {
                    $('.memberIndex .tenantV').addClass('none');
                    $('.memberIndex .userV').removeClass('none');
                    $('.memberIndex .userV span').html('已认证')
                } else if (data.IsAuthenticationSh && !data.IsAuthenticationSm) {
                    $('.memberIndex .userV').addClass('none');
                    $('.memberIndex .tenantV').removeClass('none');
                    $('.memberIndex .tenantV span').html('商家已认证')
                } else if (data.IsAuthenticationSh && data.IsAuthenticationSm) {
                    $('.memberIndex .userV').addClass('none');
                    $('.memberIndex .tenantV').removeClass('none');
                    $('.memberIndex .tenantV span').html('商家已认证')
                }

                //是否认证成商家
                if (data.IsAuthenticationSh) {
                    $('.IsAuthenticationSh .weui-cell__ft').html('已认证');
                    $(document).on('click', '.IsAuthenticationSh', function () {
                        toast.show('您已认证', 1000)
                    })
                } else {
                    $('.IsAuthenticationSh .weui-cell__ft').html('未认证');
                    $(document).on('click', '.IsAuthenticationSh', function () {
                        pageManager.go('authTenant');
                    })
                }

                //是否实名认证
                if (data.IsAuthenticationSm) {
                    $('.IsAuthenticationSm .weui-cell__ft').html('已认证');
                    $(document).on('click', '.IsAuthenticationSm', function () {
                        toast.show('您已认证', 1000)
                    })
                } else {
                    $('.IsAuthenticationSm .weui-cell__ft').html('未认证');
                    $(document).on('click', '.IsAuthenticationSm', function () {
                        pageManager.go('auth');
                    })
                }

                //是否绑定银行卡
                if (data.IsBinding) {
                    $('.IsBinding .weui-cell__ft').html('已绑定');
                    $(document).on('click', '.IsBinding', function () {
//                        toast.show('您已绑定', 1000)
                        pageManager.go('bankList')
                    })
                } else {
                    $('.IsBinding .weui-cell__ft').html('未绑定');
                    $(document).on('click', '.IsBinding', function () {
//                        pageManager.go('cardOne')
                        pageManager.go('bankList')
                    })
                }

                if (data.data.TXTP) {
                    $('.memberIndex #userHeadImg').attr('src', data.data.TXTP)
                } else {
                    $('.memberIndex #userHeadImg').attr('src', '../images/placeholder/user.png')
                }
                $('.memberIndex #username').html(data.data.XM)

                $('.memberPoint').html(data.data.JF)
            }).view({
                memberId: memberId
            })
        }

        //商户认证页面
        if (pageManager._getHash() == '#authTenant') {
            document.title = '商户认证';
            $(document).on('click', '.toggleShowDetail', function () {
                $('.showDetailForm').toggle();
                if ($(this).find('.weui-cell__ft i').hasClass('icon-up')) {
                    $(this).find('.weui-cell__ft i').removeClass('icon-up').addClass('icon-arrowbottom')
                } else {
                    $(this).find('.weui-cell__ft i').removeClass('icon-arrowbottom').addClass('icon-up')
                }
            })
            var shId;
            //填写第一步资料
            var bbusinessLicense, identityCardFront, identityCardBack, Authorizationletter, placeofBusiness,identityCardFrontno,identityCardBackno,doorHead,placeofGathering;
            var accounType = 'normal';

            $(document).on('click', '.recommend .goSubmit', function () {
                var tenantName = $('.recommend .tenantName').val();
                var linkMan = $('.recommend .linkMan').val();
                var phone = $('.recommend .phone').val();

                var bussinessNumber = $('.recommend .bussinessNumber').val();
                var identityCardNum = $('.recommend .identityCardNum').val();
                var identityCardNumno=$('.recommend .identityCardNumno').val();
                var account = $('.recommend .account').val();
                var bank = $('.recommend .bank').val();
                var bankAccount = $('.recommend .bankAccount').val();

                if (!tenantName) {
                    toast.show('请输入商家名称', 1000)
                } else if (!linkMan) {
                    toast.show('请输入联系人', 1000)
                } else if (!(/^1[0-9]{10}$/.test(phone))) {
                    toast.show('请输入正确联系电话', 1000)
                } else if (!bbusinessLicense && !identityCardFront && !identityCardBack && !Authorizationletter && !placeofBusiness && !bussinessNumber && !identityCardNum && !account && !bank && !bankAccount) {
                    new authentication(function (data) {
                        shId = data.id;
                        toast.show('提交成功', 1000)
                    }).merchantCA({
                        tenantName: tenantName,
                        linkMan: linkMan,
                        phone: phone,
                        hyId: memberId
                    })
                }
//                else if (!bussinessNumber) {
//                    toast.show('请填写营业执照号', 1000)
//                } else if (!bbusinessLicense) {
//                    toast.show('请上传营业执照照片', 1000)
//                } else if (!identityCardNum) {
//                    toast.show('请填写身份证号', 1000)
//                } else if (!identityCardFront) {
//                    toast.show('请上传身份证正面照片', 1000)
//                } else if (!identityCardBack) {
//                    toast.show('请上传身份证反面照片', 1000)
//                } else if (!account) {
//                    toast.show('请填写结算账户户名', 1000)
//                } else if (!bank) {
//                    toast.show('请填写开户行', 1000)
//                } else if (!bankAccount) {
//                    toast.show('请填写银行账户', 1000)
//                } else if (!Authorizationletter) {
//                    toast.show('请上传授权书照片', 1000)
//                } else if (!placeofBusiness) {
//                    toast.show('请上传营业场所照片', 1000)
//                }
                else {
                    new authentication(function (data) {
                        shId = data.id;
                        new authentication(function (data) {
                            dialog.show('提交资料成功', function () {
                                location.reload();
                            })
                        }).tanantsAuthoBusinessLicense({
                            bussinessNumber: bussinessNumber,
                            bbusinessLicense: bbusinessLicense,
                            identityCardNum: identityCardNum,
                            identityCardFront: identityCardFront,
                            identityCardBack: identityCardBack,
                            accounType: accounType,
                            account: account,
                            bank: bank,
                            bankAccount: bankAccount,
                            Authorizationletter: Authorizationletter,
                            placeofBusiness: placeofBusiness,
                            shId: shId,
                            FFRSFZHM:identityCardNumno,
                            FFRSFZZMZ:identityCardFrontno,
                            FFRSFZFMZ:identityCardBackno,
                            doorHead:doorHead,
                            placeofGathering:placeofGathering
                        })
                    }).merchantCA({
                        tenantName: tenantName,
                        linkMan: linkMan,
                        phone: phone,
                        hyId: memberId
                    })

                }
            });


            $("#bbusinessLicense").on('change', function (e) {
                uploadImg(e.target.files, 2, function (data, file) {
                    toast.closeLoading();
                    bbusinessLicense = data.tpname;
                    $("#bbusinessLicenseImg")[0].src = file;
                })
            });
            $("#identityCardFront").on('change', function (e) {
                uploadImg(e.target.files, 3, function (data, file) {
                    toast.closeLoading();
                    identityCardFront = data.tpname;
                    $("#identityCardFrontImg")[0].src = file;
                })
            });
            $("#identityCardBack").on('change', function (e) {
                uploadImg(e.target.files, 4
                    , function (data, file) {
                        toast.closeLoading();
                        identityCardBack = data.tpname;
                        $("#identityCardBackImg")[0].src = file;
                    })
            });
            $("#Authorizationletter").on('change', function (e) {
                uploadImg(e.target.files, 6, function (data, file) {
                    toast.closeLoading();
                    Authorizationletter = data.tpname;
                    $("#AuthorizationletterImg")[0].src = file;
                })
            });
            $("#placeofBusiness").on('change', function (e) {
                uploadImg(e.target.files, 5, function (data, file) {
                    toast.closeLoading();
                    placeofBusiness = data.tpname;
                    $("#placeofBusinessImg")[0].src = file;
                })
            });

            $("#identityCardFrontno").on('change', function (e) {
                uploadImg(e.target.files, 7, function (data, file) {
                    toast.closeLoading();
                    identityCardFrontno = data.tpname;
                    $("#identityCardFrontnoImg")[0].src = file;
                })
            });
            $("#identityCardBackno").on('change', function (e) {
                uploadImg(e.target.files, 8, function (data, file) {
                    toast.closeLoading();
                    identityCardBackno = data.tpname;
                    $("#identityCardBacknoImg")[0].src = file;
                })
            });
            $("#doorHead").on('change', function (e) {
                uploadImg(e.target.files, 9, function (data, file) {
                    toast.closeLoading();
                    doorHead = data.tpname;
                    $("#doorHeadImg")[0].src = file;
                })
            });
            $("#placeofGathering").on('change', function (e) {
                uploadImg(e.target.files, 10, function (data, file) {
                    toast.closeLoading();
                    placeofGathering = data.tpname;
                    $("#placeofGatheringImg")[0].src = file;
                })
            });


            //选择账号类型（对工/法人）
            $(document).on('click', '.selsectAccounType .weui-check__label', function () {
                var accType = $(this).attr('accType');
                accounType = accType;
            });


        }

        //历史推荐页面
        if (pageManager._getHash() == '#historyRecommend') {
            document.title = '个人中心';
            new member(function (res) {
                var h = render.fill($("#tpl_recommendList"), res.list);
                $('#recommendListSingle').html(h);
            }).recommendList({
                hyId: memberId
            });
            new member(function (res) {
                var h = render.fill($("#tpl_recommendTenantList"), res.list);
                $('#recommendListTenant').html(h);
            }).recommendTenantList({
                hyId: memberId,
                type: 0
            });
            $('.recommendTab>div').off().on('click', function () {
                if ($(this).hasClass('active')) {
                    return false;
                }
                var index = $(this).index();
                $(this).addClass('active').siblings().removeClass('active');
                $('.recommendTab-content>div').eq(index).addClass('recommendTab-show').siblings().removeClass('recommendTab-show')
            })
            $('.towLevelTab div').off().on('click', function () {
                if ($(this).hasClass('active')) {
                    return false;
                }
                var index = $(this).index();
                $(this).addClass('active').siblings().removeClass('active');
                new member(function (res) {
                    var h = render.fill($("#tpl_recommendTenantList"), res.list);
                    $('#recommendListTenant').html(h);
                }).recommendTenantList({
                    hyId: memberId,
                    type: index
                });
            })

        }

        //设置
        if (window.location.hash == '#setting') {
            document.title = '设置';
            $(document).on('click', '.goQuitLogin', function () {
                dialog.query('是否确认退出登陆?', function () {
                    setTimeout(function () {
                        localStorage.setItem('loginID', '');
                        location.href = '../login/index.html'
                    }, 500)
                })
            })
        }

        //修改绑定的手机号
        if (window.location.hash == '#changeBind') {
            document.title = '修改绑定手机';
            var countdown = 60;
            var canSend = true;

            function settime(val) {
                if (countdown == 0) {
                    canSend = true;
                    val.innerHTML = "发送验证码";
                    val.style.color = "#3782d9";
                    countdown = 60;
                    return;
                } else {
                    canSend = false;
                    val.innerHTML = "重新发送(" + countdown + ")";
                    val.style.color = "#999";
                    countdown--;
                }
                setTimeout(function () {
                    settime(val)
                }, 1000)
            }


            //发送验证码
            $(document).on('click', '.sendChangeBind', function () {
                if (canSend) {
                    var $this = this;
                    //手机号校验
                    var phoneNumber = $('.changeBindPage .oldPhone').val();
                    if (!(/^1[0-9]{10}$/.test(phoneNumber))) {
                        toast.show('请输入正确手机号', 1000);
                        return false;
                    } else {
                        new common(function (data) {
                            console.log(data);
                            settime($this);
                            canSend = false;
                        }).sendCode({
                            phoneNumber: phoneNumber,
                            type: 1
                        })
                    }
                }
            });

            //修改手机号保存提交
            $(document).on('click', '.goChangeBind', function () {
                var oldPhone = $('.changeBindPage .oldPhone').val();
                var newPhone = $('.changeBindPage .newPhone').val();
                var authCode = $('.changeBindPage .authCode').val();
                if (!(/^1[0-9]{10}$/.test(oldPhone))) {
                    toast.show('原手机号格式不正确', 1000)
                } else if (!(/^1[0-9]{10}$/.test(newPhone))) {
                    toast.show('新手机号格式不正确', 1000)
                } else if (!authCode) {
                    toast.show('请输入验证码')
                } else {
                    new member(function (data) {
                        console.log(data);
                        pageManager.back();
                    }).mobilePhone({
                        mobile: oldPhone,
                        currentMobile: newPhone,
                        AuthoCode: authCode,
                        id: memberId
                    })
                }
            })
        }


        //绑定银行卡第一步
        if (window.location.hash == '#cardOne') {
            document.title = '绑定银行卡';
            var countdown = 60;
            var canSend = true;

            function settime(val) {
                if (countdown == 0) {
                    canSend = true;
                    val.innerHTML = "发送验证码";
                    val.style.color = "#3782d9";
                    countdown = 60;
                    return;
                } else {
                    canSend = false;
                    val.innerHTML = "重新发送(" + countdown + ")";
                    val.style.color = "#999";
                    countdown--;
                }
                setTimeout(function () {
                    settime(val)
                }, 1000)
            }

            //发送验证码
            $(document).on('click', '.useAddBank .sendBankcode', function () {
                if (canSend) {
                    var $this = this;
                    //手机号校验
                    var phoneNumber = $('.useAddBank .ylsjh').val();
                    if (!(/^1[0-9]{10}$/.test(phoneNumber))) {
                        toast.show('请输入正确手机号', 1000);
                        return false;
                    } else {
                        new common(function (data) {
                            console.log(data);
                            settime($this);
                            canSend = false;
                        }).sendCode({
                            phoneNumber: phoneNumber,
                            type: 2
                        })
                    }
                }
            });
            $(document).on('click', '.useAddBank .gocardTwo', function () {
                var zsxm = $('.useAddBank .zsxm').val();
                var yhkh = $('.useAddBank .yhkh').val();
                var fkjg = $('.useAddBank .fkjg').val();
                var ylsjh = $('.useAddBank .ylsjh').val();
                var authoCode = $('.useAddBank .authoCode').val();
                if (!zsxm) {
                    toast.show('请输入持卡人姓名', 1000)
                } else if (!yhkh) {
                    toast.show('请输入银行卡号', 1000)
                } else if (!fkjg) {
                    toast.show('请填写银行名称', 1000)
                } else if (!ylsjh) {
                    toast.show('请填写预留手机号', 1000)
                } else if (!authoCode) {
                    toast.show('请填写验证码', 1000)
                } else {
                    toast.show('添加成功', 1000)
                    new member(function (data) {
                        pageManager.replace('cardThree')
                    }).addBinding({
                        zsxm: zsxm,
                        yhkh: yhkh,
                        fkjg: fkjg,
                        ylsjh: ylsjh,
                        authoCode: authoCode,
                        hyId: memberId
                    })

                }


            })
        }


        //绑定银行卡第三步
        if (window.location.hash == '#cardThree') {
            document.title = '绑定银行卡';
            $(document).on('click', '.goCardSuccess', function () {
                pageManager.back()
            })
        }

        //银行卡列表
        if (window.location.hash == '#bankList') {
            new member(function (res) {
                var h = render.fill($("#tpl_bankCardList"), res.list);
                $('.bank_list .weui-cells').html(h);
                $(document).on('click', '.remove_bankCard', function () {
                    $(this).parent('.weui-cell').remove();
                })
            }).bindingListGet({
                hyId: memberId
            });
        }

        //个人信息
        if (window.location.hash == '#tenantInfo') {
            document.title = '商家信息';
        }

        if (window.location.hash == '#userInfo') {
            document.title = '个人信息';
            $(document).on('click', '.openAddress', function () {
                weixin.address({
                    success: function (res) {
                        // let userName = res.userName; // 收货人姓名
                        let detailInfo = res.detailInfo; // 详细收货地址信息
                        // let nationalCode = res.nationalCode; // 收货地址国家码
                        // let telNumber = res.telNumber; // 收货人手机号码
                        new area(function (res) {
                            $('.member_user_info .address .weui-cell__ft').html(detailInfo)
                        }).updateAddress({
                            memberId: memberId,
                            address: detailInfo
                        })
                    }
                })
            })
            new member(function (data) {
                $('.member_user_info .headImg').attr('src', data.data.TXTP)
                $('.member_user_info .name').html(data.data.XM)
                $('.member_user_info .sex input').val(data.data.XB)
                $('.member_user_info .age input').val(data.data.NL)
                $('.member_user_info .phone').html(data.data.SJHM)
                $('.member_user_info .idCard').html(data.data.SFZHM)
                $('.member_user_info .address .weui-cell__ft').html(data.data.CZDZ)
            }).view({
                memberId: memberId
            })
            
            $(document).on('click','.saveInfo',function () {
                dialog.query('确认保存个人信息？',function () {
                    new member(function (data) {
                        toast.show('保存成功',1000)
                    }).updatePersonalInformation({
                        XB: $('.member_user_info .sex input').val(),
                        NL:$('.member_user_info .age input').val(),
                        id:memberId
                    })
                })

            })
        }


        //使用积分
        if (window.location.hash == '#usePoint') {
            document.title = '使用积分';
            var useStatus=false;
            new point(function (data) {
                $('.usePoint .usePointAmount').html(data.jf);
                $('.usePoint .useMoney').html(data.money);
                $('.weui-switch').on('click',function () {
                    useStatus=!useStatus;
                    if(!useStatus){
                        $('.usePoint .trueAmount').html( $('.usePoint .useMoney').val());
                    }else{
                        $('.usePoint .trueAmount').html(parseInt($('.usePoint .useMoney').val())-parseInt(data.money));
                    }
                });

                $('.usePoint .useMoney').bind('input propertychange', function() {
                    console.log(useStatus)
                    if(!useStatus){
                        $('.usePoint .trueAmount').html( $('.usePoint .useMoney').val());
                    }else{
                        $('.usePoint .trueAmount').html(parseInt($('.usePoint .useMoney').val())-parseInt(data.money));
                    }
                })

                $(document).on('click','.confirmUseBtn',function () {
                    var shmc=$('.usePoint .tenantName').val();
                    if(!useStatus){
                        weixin.scanQRCode({
                            desc:'请扫描商家收款码'
                        })
                    }else if(useStatus && data.jf==0){
                        weixin.scanQRCode({
                            desc:'请扫描商家收款码'
                        })
                    }else{
                        new point(function () {
                            weixin.scanQRCode({
                                desc:'请扫描商家收款码'
                            })
                        }).useIntegral({
                            hyId:memberId,
                            shmc:shmc,
                            jf:useStatus?data.jf:0
                        })
                    }
                })

            }).view({
                id: memberId
            })



        }

        //积分记录
        if (window.location.hash == '#listPoint') {
            document.title = '积分记录';
            new point(function (data) {
                $('.listPoint #balance').html(data.jf)
            }).view({
                id: memberId
            })

            new point(function (data) {
                var h = render.fill($("#tpl_pointListTpl"), data.list);
                $('.listPointTplWrap').html(h)
            }).selectIntegralRecord({
                hyid: memberId
            })


            $('.chooseMonth').on('click', function () {
                var date=new Date();
                var year=date.getFullYear();
                var month=date.getMonth()+1;
                weui.datePicker({
                    start: 2015, //开始月份
                    end: new Date().getFullYear(),  //结束为当前年份
                    depth:2,
                    defaultValue: [year,month],
                    //日期选择时执行方法
                    onChange: function (result) {
                        //隐藏日的显示,只显示年月
                        $('.weui-picker__group').eq(2).css('display','none');
                    },
                    //日期确定后执行方法
                    onConfirm: function (result) {
                        $('.chooseMonth').html(result[0].value+'年'+result[1].value+'月');     //选择时当前年份值

                        new point(function (data) {
                            var h = render.fill($("#tpl_pointListTpl"), data.list);
                            $('.listPointTplWrap').html(h)
                        }).selectIntegralRecord({
                            hyid: memberId,
                            month:result[1].value,
                            Year:result[0].value
                        })
                    }
                });
                $('.weui-picker__group').eq(2).css('display','none');
            });


        }



        //积分提现
        if (window.location.hash == '#cashPoint') {
            document.title = '积分提现';
            var BKID,KHYH,YHKH,JMKH
            $(document).on('click','.clickCard',function () {
                $('.remove_bankCart').remove()
                $("#actionSheet_contact_merchant").actionsheet();
            })

            $(document).on('click','.address .weui-cell',function () {
                BKID=$(this).attr('data-id');
                KHYH=$(this).attr('data-KHYH');
                YHKH=$(this).attr('data-YHKH');
                JMKH=$(this).attr('data-JMKH');
                $('.cashPoint .bankName').val(KHYH+'尾号'+JMKH)
                $("#actionSheet_contact_merchant").actionsheetClose();
            })

            new member(function (res) {
                var h = render.fill($("#tpl_bankCardList"), res.list);
                $('#actionSheet_contact_merchant .address').html(h);
                $(document).on('click', '.remove_bankCard', function () {
                    $(this).parent('.weui-cell').remove();
                })
                if(res.list.length){
                    BKID=res.list[0].ID;
                    KHYH=res.list[0].FKJG;
                    YHKH=res.list[0].YHKH;
                    JMKH=res.list[0].JMKH;
                    $('.cashPoint .bankName').val(KHYH+'尾号'+JMKH)
                }
            }).bindingListGet({
                hyId: memberId
            });

            new point(function (data) {
                $('.cashPoint #balance').html(data.jf)
                $('.cashPoint .allPoint').html(data.jf)
                $(document).on('click','.getCashAll',function () {
                    $('.cashPointAmount').val(data.jf)
                })
            }).view({
                id: memberId
            })
            $(document).on('click', '.goCashPoint', function () {
                var TXJF=$('.cashPointAmount').val();
                if(!TXJF){
                    toast.show('请输入提现积分',1000)
                }else if(!BKID){
                    toast.show('请先去绑定银行卡',1000)
                }else{
                    new point(function () {
                        pageManager.go('cashSuccess')
                    }).wthdrawals({
                        hyid:memberId,
                        KHYH:KHYH,
                        YHKH:YHKH,
                        BKID:BKID,
                        TXJF:TXJF
                    })
                }
            })
        }

        //积分赠送
        if (window.location.hash == '#givePoint') {
            document.title = '积分赠送';

            var hasjf;
            new point(function (data) {
                hasjf=data.jf;
                $('.givePointWrap .givePointc').attr('placeholder','请填写赠送积分,'+'可用积分('+data.jf+')')
            }).view({
                id:memberId
            })

            $('.givePointWrap .givePointc').bind('input propertychange', function() {
                console.log( $('.givePointWrap .givePointc').val());
                if($('.givePointWrap .givePointc').val()>hasjf){
                    $('.givePointWrap .givePointc').val(hasjf);
                    toast.show('您最大赠送积分额度为'+hasjf,1000)
                }
            })
                new member(function (data) {
                var phoneNumber=data.data.SJHM;
                var countdown = 60;
                var canSend = true;
                function settime(val) {
                    if (countdown == 0) {
                        canSend = true;
                        val.innerHTML = "发送验证码";
                        val.style.color = "#3782d9";
                        countdown = 60;
                        return;
                    } else {
                        canSend = false;
                        val.innerHTML = "重新发送(" + countdown + ")";
                        val.style.color = "#999";
                        countdown--;
                    }
                    setTimeout(function () {
                        settime(val)
                    }, 1000)
                }
                //发送验证码
                $(document).on('click', '.givePointWrap .sendCode', function () {
                    if (canSend) {
                        var $this = this;
                        //手机号校验
                            new common(function (data) {
                                console.log(data);
                                settime($this);
                                canSend = false;
                            }).sendCode({
                                phoneNumber: phoneNumber,
                                type: 4
                            })
                    }
                });

            }).view({
                memberId:memberId
            })
            $(document).on('click', '.goGivePoint', function () {
                var yhzh=$('.givePointWrap .giveAccount').val();
                var jf=$('.givePointWrap .givePointc').val();
                var yzm=$('.givePointWrap .code').val();
                if(!yhzh){
                    toast.show('请填写赠送账户',1000)
                }else if(!jf){
                    toast.show('请填写赠送积分',1000)
                }else if(!yzm){
                    toast.show('请填写验证码',1000)
                }else{
                    new point(function (res) {
                        
                    }).givEIntegral({
                        yhzh:yhzh,
                        jf:jf,
                        yzm:yzm,
                        hyid:memberId
                    })
                }
            })
        }

        //积分提现成功页面
        if (window.location.hash == '#cashSuccess') {
            document.title = '提现成功';
            $(document).on('click', '.goCashEnd', function () {
                pageManager.back()
            })
        }


        //帮助中心
        if (window.location.hash == '#help') {
            document.title = '帮助中心';
            pget = pget || $(".pageable").pageable({
                loadUpFn: function (me) {
                    new member(function (data) {
                        var h = render.fill($("#tpl_helpList"), data.pageList);
                        $('.pageable .memberHelp').html(h)
                        pget.resetload();
                    }).help({
                        page: 1
                    });
                },
                loadDownFn: function (me) {
                    new member(function (data) {
                        me.pageNumber += 1;
                        var h = render.fill($("#tpl_helpList"), data.pageList);
                        $('.pageable .memberHelp').append(h)
                        if (data.pageList.length < 10) {
                            me.lock();
                            me.noData();
                        }
                        else {
                            me.noData(false);
                        }
                        me.resetload();
                    }).help({
                        page: me.pageNumber
                    });

                    //                    })
                }
            });

        }

        //邀请朋友
        if (window.location.hash == '#invite') {
            document.title = '邀请好友';
            var $iosMask = $('.weui-mask');

            function hideActionSheet() {
                $iosMask.fadeOut(200);
                $(".shareModelSwap").css("display", "none");
            }

            $iosMask.on('click', hideActionSheet);
            $('.shareModelSwap').on('click', hideActionSheet);
            $(document).on('click', '.goInvite', function () {
                $iosMask.fadeIn(200);
                $('.shareModelSwap').css("display", "block");
            })
            weixin.share1({
                title: '海绵思维平台',
                desc: '海绵思维是以渠道代理为银行等金融机构营销各类商户办理POS机、收款二维码支付体系',
                link: 'http://www.himisw.com/weixin/member/index.html?#inviteSuccess',
                imgUrl: 'http://www.himisw.com/weixin/images/static/member/logo.png'
            })
        }

        //邀请朋友分享页面
        if (window.location.hash == '#inviteSuccess') {
            document.title = '邀请注册';
            $(document).on('click', '.clickLogin', function () {
                location.href = '../member/invite.html'
            })
        }

        //关于我们
        if (window.location.hash == '#aboutUs') {
            document.title = '关于我们';
            new member(function (data) {
                $('.memberHelpCon').html(data.time.NR)
            }).about()
        }


        //实名认证
        if (window.location.hash == '#auth') {
            hiddenBtn.bind();
            document.title = '实名认证';
            var img1src;
            var img2src;
            $("#idcard1").on('change', function (e) {
                uploadImg(e.target.files, 0, function (data, file) {
                    toast.closeLoading();
                    img1src = data.tpname;
                    $("#uploadimg1")[0].src = file;
                })
            });

            $("#idcard2").on('change', function (e) {
                uploadImg(e.target.files, 1, function (data, file) {
                    toast.closeLoading();
                    img2src = data.tpname;
                    $("#uploadimg2")[0].src = file;
                })
            });

            $("#sendcerti").on('click', function () {
                var name = $("#name").val();
                var idcard = $("#idcard").val();
                if (name == '') {
                    toast.show('请输入姓名');
                } else if (!idcard.match(/^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/)) {
                    toast.show('请正确输入身份证号');
                } else {
                    new member(function (data) {
                        dialog.show('提交成功，请耐心等待！', function () {
                            pageManager.back()
                        });
                    }).realNameAuthen({
                        name: name,
                        identificationcardNumber: idcard,
                        positiveCart: img1src,
                        negative: img2src,
                        hyId: memberId
                    });
                }
            })
        }

        //绑定手机
        if (window.location.hash == '#bind') {
            document.title = '绑定手机';
            hiddenBtn.bind();

            var host = window.location.host;
            //域名为直通邦
            if (/www.ztbmall.com/gi.test(host)) {
                $('.user_addphone .tiaohuo').html('腻了吗');
            } else {
                $('.user_addphone .tiaohuo').html('平台');
            }
            new member(function (data) {
                if (data.bindMobile == 'binded') {
                    $('#mobnum').val(data.mobile);
                    $('#login').html('您已绑定');
                    $('#login').css('background', '#999');
                    $("#getcap").css('background', '#999');
                    $("#login").unbind('click');
                    $("#getcap").unbind('click');
                }
            }).view();
            var countdown = 60;

            function settime(val) {
                if ($('#mobnum').val() != "") {
                    if (countdown == 0) {
                        val.removeAttribute("disabled");
                        val.value = "发送验证码";
                        val.style.background = "#00a0e9";
                        countdown = 60;
                        return;
                    } else {
                        val.setAttribute("disabled", true);
                        val.value = "重新发送(" + countdown + ")";
                        val.style.background = "#999";
                        countdown--;
                    }
                    setTimeout(function () {
                        settime(val)
                    }, 1000)
                }
            }

            //绑定手机获取验证码
            $("#getcap").click(function () {
                var mobnum = $("#mobnum").val();
                if (mobnum == "") {
                    toast.show("请输入手机号码");
                } else {
                    settime(this);
                    var me = new member(function (data) {
                    });
                    me.sendCode({mobile: mobnum})
                }
            });
            //绑定手机
            $("#login").click(function () {
                var check = document.getElementById("weuiAgree");
                var mobnum = $("#mobnum").val();
                var capt = $("#captcha").val();
                var invite = $("#inviteCode").val();
                if (check.checked == true) {
                    var me = new member(function (data) {
                        toast.show("绑定成功");
                        setTimeout(function () {
                            if (pageManager.GetQueryString('type') == 'password') {
                                location.replace('../payment/payPassword.html')
                            } else {
                                pageManager.back();
                            }
                            //                            window.location.href = document.referrer;
                        }, 1000);
                    });
                    me.bindMobile({mobile: mobnum, captcha: capt, inviteCode: invite});
                } else {
                    toast.show("请同意协议")
                }
            })
        }

    };
    window.addEventListener('pageGoOk', pageFn)
</script>
</body>

</html>