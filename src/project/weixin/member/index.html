<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>个人中心</title>
    @import "../include/header.inc";
    <link rel="stylesheet" href="/weixin/style/wap.min.css"/>
</head>
<body>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>

<!--会员首页-->
<link rel="import" href="../../../pages/member/index.html">

<!--设置-->
<link rel="import" href="../../../pages/member/setting/setting.html">
<link rel="import" href="../../../pages/member/setting/changeBind.html">

<!--认证商家-->
<link rel="import" href="../../../pages/member/authTenant.html">

<!--积分-->
<link rel="import" href="../../../pages/member/point/cashPoint.html">
<link rel="import" href="../../../pages/member/point/cashSuccess.html">
<link rel="import" href="../../../pages/member/point/givePoint.html">
<link rel="import" href="../../../pages/member/point/listPoint.html">
<link rel="import" href="../../../pages/member/point/usePoint.html">
<!--邀请好友-->
<link rel="import" href="../../../pages/member/invite/invite.html">
<link rel="import" href="../../../pages/member/invite/inviteSuccess.html">

<!-- 历史推荐 -->
<link rel="import" href="../../../pages/member/recommend/historyRecommend.html">

<!--帮助中心-->
<link rel="import" href="../../../pages/member/help/help.html">
<link rel="import" href="../../../pages/member/help/helpView.html">

<!--关于我们-->
<link rel="import" href="../../../pages/member/aboutUs.html">


<!--绑定手机与实名认证-->
<link rel="import" href="../../../pages/member/bind.html">    <!--绑定手机-->
<link rel="import" href="../../../pages/member/auth.html">    <!--实名认证-->

<!--个人信息-->
<link rel="import" href="../../../pages/member/info/tenantInfo.html">
<!--商家信息-->
<link rel="import" href="../../../pages/member/info/userInfo.html">

@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/common.min.js"></script>
<script src="/weixin/js/wap.min.js"></script>
<script type="text/javascript">
    window.onpageshow = function (ev) {
        if(pageManager._getHash()=='#orderList'){
            if (ev.persisted && WeixinJSBridge) {
                window.location.reload()
            }
        }
    };
    $(function(){
        pageManager.show("index");
    })
    var pageFn = function(){
        //个人中心页面
        if(pageManager._getHash()=='#'){
            document.title='个人中心';
        }

        //设置
        if(window.location.hash=='#setting'){
            document.title='设置';
        }

        //设置
        if(window.location.hash=='#tenantInfo'){
            document.title='商家信息';
        }
        if(window.location.hash=='#userInfo'){
            document.title='个人信息';
        }


        //使用积分
        if(window.location.hash=='#usePoint'){
            document.title='使用积分';
        }

        //积分提现
        if(window.location.hash=='#cashPoint'){
            document.title='积分提现';
            $(document).on('click','.goCashPoint',function () {
                pageManager.go('cashSuccess')
            })
        }
        //积分提现成功页面
        if(window.location.hash=='#cashSuccess'){
            document.title='积分提现';
            $(document).on('click','.goCashEnd',function () {
                pageManager.back()
            })
        }

        //商户认证
        if(window.location.hash=='#authTenant'){
            document.title='商户认证';
            $(document).on('click','.toggleShowDetail',function () {
                $('.showDetailForm').toggle();
                if($(this).find('.weui-cell__ft i').hasClass('icon-up')){
                    $(this).find('.weui-cell__ft i').removeClass('icon-up').addClass('icon-arrowbottom')
                }else{
                    $(this).find('.weui-cell__ft i').removeClass('icon-arrowbottom').addClass('icon-up')
                }
            })
        }



        //帮助中心
        if(window.location.hash=='#help'){
            document.title='帮助中心';
        }

        //邀请朋友
        if(window.location.hash=='#invite'){
            document.title='邀请好友';
            var $iosMask = $('.weui-mask');
            function hideActionSheet(){
                $iosMask.fadeOut(200);
                $(".shareModelSwap").css("display","none");
            }
            $iosMask.on('click', hideActionSheet);
            $('.shareModelSwap').on('click',hideActionSheet);
            $(document).on('click','.goInvite',function () {
                $iosMask.fadeIn(200);
                $('.shareModelSwap').css("display","block");
            })
        }

        //邀请朋友分享页面
        if(window.location.hash=='#inviteSuccess'){
            document.title='邀请注册';
           $(document).on('click','.clickLogin',function () {
               location.href='../register/index.html'
           })
        }
        //关于我们
        if(window.location.hash=='#aboutUs'){
            document.title='关于我们';
        }


        //实名认证
        if(window.location.hash=='#auth'){
            hiddenBtn.bind();
            //正面图片预览方法
            function getFullPath() {
                var file=document.getElementById('idcard1');
                var fileList = file.files;
                var img=document.getElementById("uploadimg1");
                for(var i=0;i<fileList.length;i++){
                    if(file.files[0]){
                        img.style.display = 'block';
                        img.style.width = '112px';
                        img.style.height = '80px';
                        if (window.createObjectURL!=undefined) { // basic
                            img.src = window.createObjectURL(file.files[0]);
                        } else if (window.URL!=undefined) { // mozilla(firefox)
                            img.src = window.URL.createObjectURL(file.files[0]);
                        } else if (window.webkitURL!=undefined) { // webkit or chrome
                            img.src = window.webkitURL.createObjectURL(file.files[0]);
                        }
                    }
                    var f_i= new FormData();
                    f_i.append("file",fileList[i])
                }
            }
            //反面图片预览方法
            function getFullPath2() {
                var file=document.getElementById('idcard2');
                var fileList = file.files;
                var img=document.getElementById("uploadimg2");
                for(var i=0;i<fileList.length;i++){
                    if(file.files[0]){
                        img.style.display = 'block';
                        img.style.width = '112px';
                        img.style.height = '80px';
                        if (window.createObjectURL!=undefined) { // basic
                            img.src = window.createObjectURL(file.files[0]);
                        } else if (window.URL!=undefined) { // mozilla(firefox)
                            img.src = window.URL.createObjectURL(file.files[0]);
                        } else if (window.webkitURL!=undefined) { // webkit or chrome
                            img.src = window.webkitURL.createObjectURL(file.files[0]);
                        }
                    }
                    var f_i= new FormData();
                    f_i.append("file",fileList[i])
                }
            }

            document.title='实名认证';
            var img1src;
            var img2src;
            $("#idcard1").on('change',function () {
                toast.loading2('上传中');
                $('#loadingToast').css('opacity',1);
                var fl = new file(function (data) {
                    getFullPath();
                    img1src=data;
//                    $('.certification #uploadimg1').attr('src',data);
                    $('#loadingToast').css('opacity',0);
                });
                fl.uploadImage(new FormData($("#idform1")[0]));
            });
            $("#idcard2").on('change',function () {
                toast.loading2('上传中');
                $('#loadingToast').css('opacity',1);
                var fl = new file(function (data) {
                    img2src=data;
                    getFullPath2();
                    $('#loadingToast').css('opacity',0);
//                    $('.certification #uploadimg2').attr('src',data);
                });
                fl.uploadImage(new FormData($("#idform2")[0]));
            });
            $("#sendcerti").on('click',function () {
                var name=$("#name").val();
                var idcard=$("#idcard").val();
                if(name==''){
                    toast.show('请输入姓名');
                }else if(!idcard.match(/^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/)){
                    toast.show('请正确输入身份证号');
                }else{
                    var me=new member(function(data){
                        dialog.show('提交成功，请耐心等待！');
                        setTimeout(function () {
                            pageManager.back();
                        },1000);
                    });
                    me.realNameAuthen({name:name,idcard:idcard,pathFront:img1src,pathBack:img2src});
                }
            })
        }

        //绑定手机
        if(window.location.hash=='#bind'){
            document.title='绑定手机';
            hiddenBtn.bind();

            var host = window.location.host;
            //域名为直通邦
            if(/www.ztbmall.com/gi.test(host)){
                $('.user_addphone .tiaohuo').html('腻了吗');
            }else{
                $('.user_addphone .tiaohuo').html('平台');
            }
            new member(function (data) {
                if(data.bindMobile=='binded'){
                    $('#mobnum').val(data.mobile);
                    $('#login').html('您已绑定');
                    $('#login').css('background','#999');
                    $("#getcap").css('background','#999');
                    $("#login").unbind('click');
                    $("#getcap").unbind('click');
                }
            }).view();
            var countdown=60;
            function settime(val) {
                if($('#mobnum').val()!=""){
                    if (countdown == 0) {
                        val.removeAttribute("disabled");
                        val.value="发送验证码";
                        val.style.background="#00a0e9";
                        countdown = 60;
                        return;
                    } else {
                        val.setAttribute("disabled", true);
                        val.value="重新发送(" + countdown + ")";
                        val.style.background="#999";
                        countdown--;
                    }
                    setTimeout(function() {
                        settime(val)
                    },1000)
                }
            }
            //绑定手机获取验证码
            $("#getcap").click(function(){
                var mobnum=$("#mobnum").val();
                if(mobnum==""){
                    toast.show("请输入手机号码");
                }else{
                    settime(this);
                    var me=new member(function(data){
                    });
                    me.sendCode({mobile:mobnum})
                }
            });
            //绑定手机
            $("#login").click(function(){
                var check=document.getElementById("weuiAgree");
                var mobnum=$("#mobnum").val();
                var capt=$("#captcha").val();
                var invite=$("#inviteCode").val();
                if(check.checked==true){
                    var me=new member(function(data){
                        toast.show("绑定成功");
                        setTimeout(function () {
                            if(pageManager.GetQueryString('type')=='password'){
                                location.replace('../payment/payPassword.html')
                            }else{
                                pageManager.back();
                            }
//                            window.location.href = document.referrer;
                        },1000);
                    });
                    me.bindMobile({mobile:mobnum,captcha:capt,inviteCode:invite});
                }else{
                    toast.show("请同意协议")
                }
            })
        }

    };
    window.addEventListener('pageGoOk',pageFn)
</script>
</body>
</html>

