<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>个人中心</title>
    @import "../include/header.inc";
    <link rel="stylesheet" href="/weixin/style/member.min.css"/>
</head>
<body>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>


<!--会员首页-->
<link rel="import" href="../../../pages/member/index.html">

<!--钱包页面-->
<link rel="import" href="../../../pages/member/purse/purseIndex.html">  <!--钱包首页-->
<link rel="import" href="../../../pages/member/purse/cashBank.html">    <!--体现到银行-->
<link rel="import" href="../../../pages/member/purse/cashWeixin.html">  <!--体现到微信-->
<link rel="import" href="../../../pages/member/purse/charge.html">      <!--钱包充值-->
<link rel="import" href="../../../pages/member/purse/bank.html">        <!--银行卡列表-->
<link rel="import" href="../../../pages/member/purse/addBank.html">     <!--添加银行卡-->
<link rel="import" href="../../../pages/member/purse/billList.html">    <!--账单页面-->

<!--我的订单部分-->
<link rel="import" href="../../../pages/member/order/orderList.html">  <!--订单列表-->
<link rel="import" href="../../../pages/member/order/orderView.html"> <!--订单详情-->
<link rel="import" href="../../../pages/member/order/orderEvaluate.html">    <!--订单评价-->

<!--绑定手机与实名认证-->
<link rel="import" href="../../../pages/member/bind.html">    <!--绑定手机-->
<link rel="import" href="../../../pages/member/auth.html">    <!--实名认证-->

<!--收藏部分-->
<link rel="import" href="../../../pages/member/favorite/favoriteTenant.html">  <!--收藏商家-->
<link rel="import" href="../../../pages/member/favorite/favoriteGuide.html">   <!--收藏导购-->
<link rel="import" href="../../../pages/member/favorite/favoriteProduct.html"> <!--收藏商品-->
<link rel="import" href="../../../pages/member/favorite/favoriteNew.html">     <!--收藏资讯-->

<!--消息部分-->
<link rel="import" href="../../../pages/member/message/message.html">       <!--消息首页-->
<link rel="import" href="../../../pages/member/message/billMes.html">       <!--账单消息-->
<link rel="import" href="../../../pages/member/message/orderMes.html">      <!--订单消息-->
<link rel="import" href="../../../pages/member/message/systemMes.html">     <!--系统消息-->

<!--合伙人招募部分-->
<link rel="import" href="../../../pages/member/partner/recruitPartner.html">
<link rel="import" href="../../../pages/member/partner/invitePartner.html">


<!--我要开店-->
<link rel="import" href="../../../pages/member/shop/openshop.html">
<link rel="import" href="../../../pages/member/shop/openshopDown.html">


<!---------------模版---------------------------------------->
<link rel="import" href="../../../model/templete/member/purse/bankList.html">   <!--银行卡列表模板-->


<!--我的订单部分模板-->
<link rel="import" href="../../../model/templete/member/order/list.html">        <!--我的订单列表模板-->
<link rel="import" href="../../../model/templete/member/order/view.html">       <!--我的订单详情模板-->
<link rel="import" href="../../../model/templete/member/order/evaluate.html">  <!--我的订单评价模板-->

<!--消息部分-->
<link rel="import" href="../../../model/templete/member/message/billMessage.html">        <!--我的账单消息模板-->
<link rel="import" href="../../../model/templete/member/message/orderMessage.html">        <!--我的订单消息模板-->
<link rel="import" href="../../../model/templete/member/message/systemMessage.html">        <!--我的系统消息模板-->


<link rel="import" href="../../../model/templete/member/partner/partnerInfo.html">        <!--合伙人-->

<!--收藏部分-->
<link rel="import" href="../../../model/templete/member/favorite/articleList.html">       <!--我的收藏资讯模板-->
<link rel="import" href="../../../model/templete/include/tenantList.html">       <!--我的收藏商家模板-->
<link rel="import" href="../../../model/templete/product/view/shopGuideTemp.html">     <!--我的收藏导购模板-->
<link rel="import" href="../../../model/templete/search/productList.html">      <!--<!--我的收藏商品>-->
@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/common.min.js"></script>
<script src="/weixin/js/wap.min.js"></script>
<script type="text/javascript">

    function inputNumFixed2(obj){
        obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
        obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
        obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
        obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数
        if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
            obj.value= parseFloat(obj.value);
        }
    }
    $(document).on('keyup','.getcash',function(){
        inputNumFixed2(this)
    })

    function refresf() {
        setTimeout(function () {
            new member(function (data) {
                $("#username1").html(data.displayName);
                $("#username2").html(data.displayName);   //二维码界面姓名
                if(data.headImg){
                    $(".memberNew #img1").attr('src',data.headImg);
                }else{
                    $(".memberNew #img1").attr('src','../images/static/guide/dmLogo.png');
                }
                $(".Bomb #img2").attr('src',data.headImg);//二维码界面头像
                $('#praisesCount').html(data.praisesCount);
                $('#favoriteMemberCount').html(data.favoriteMemberCount);
                $('#favoriteProductCout').html(parseInt(data.favoriteProductCout)+parseInt(data.favoriteTenantCount)+parseInt(data.favoriteArticleCount));
                //未读消息的数量
                new message(function (data) {
                    var allCount=parseInt(data.message)+parseInt(data.order)+parseInt(data.account);
                    var em = '<div style="background:red;width: 12px;height: 12px;line-height:12px;border-radius: 50%;font-size: 10px;position: absolute;top: -5px;right: -9px;"></div>';
                    if(allCount > 0){
                        $('#contactCount').html(allCount+em);
                    }else if (allCount == 0){
                        $('#contactCount').html(allCount);
                    }
                }).count();


                if(data.bindMobile=='binded'){
                    $('#bindmobile').html(data.mobile);
                    $('.bindphone').on('click',function () {
                        toast.show('您已绑定!');
                    })
                }else{
                    $('#bindmobile').html('未绑定');
                    $('.bindphone').on('click',function () {
                        pageManager.go('bind');
                    })
                };

                if(data.authStatus=='success'){
                    $('#spread').html("已认证");
                    $('.ifspread').removeAttr("href");
                }else if(data.authStatus=='wait'){
                    $('.ifspread').removeAttr("href");
                    $('#spread').html("认证中");
                }else{
                    $('#spread').html("未认证");
                }
//                var couponLength;
//                var redPacketLength;
//                new coupon(function (data) {
//                    couponLength=data.length;
//                    new redPacket(function (data) {
//                        redPacketLength=data.length;
//                        $('#fansCount').html(redPacketLength+couponLength);
//                    }).list();
//                }).list();
                //我的卡包数量
                var couponLength;
                new card(function (data) {
                    couponLength=data.cards.length;
                    $('#fansCount').html(couponLength);
                }).list();


            }).view();

            new member(function(data){
                $('.purse_amount #balance').html(data.balance);
                $(".purse_info #canget").html(data.balance);
                $(".purse_info .freezeBalance").html(data.freezeBalance);
            }).balance();

            var co=new message(function (data) {
                if(data.order!=0){
                    $('.countorder').removeClass('none');
                }else{
                    $('.countorder').addClass('none');
                }
                if(data.account!=0){
                    $('.countbill').removeClass('none');
                }else{
                    $('.countbill').addClass('none');
                }
                if(data.message!=0){
                    $('.countsys').removeClass('none');
                }else{
                    $('.countsys').addClass('none');
                }
            });
            co.count();


        },50);
    }
    window.onpageshow = function (ev) {
        if(pageManager._getHash()=='#orderList'){
            if (ev.persisted && WeixinJSBridge) {
                window.location.reload()
            }
        }
    };
    function gomemberHome(url){
        var time = +new Date();
        location.replace('../member/index.html?time='+time+'#'+url)
    }
    $(function(){
        pageManager.show("index");
    })
    var pageFn = function(){
        if (/(Android)/i.test(navigator.userAgent)) {
            $('.getcash').attr('type','tel');
        }

        //个人中心页面
        if(pageManager._getHash()=='#'){
            document.title='个人中心';
            refresf();
        }
        var hp = new ad(function(data){
            if (data.length != 0) {
                var obj = data[0];
                if (obj.linkType == "tenant") {
                    $("#banner_hp").attr("href", "../tenant/index.jhtml?id=" + obj.linkId);
                } else if (obj.linkType == "product") {
                    $("#banner_hp").attr("href", "../product/view.html?id=" + obj.linkId);
                }else if (obj.linkType == "unionActivity") {
                    $("#banner_hp").attr("href", "../activity/index.html?linkId=" + obj.linkId);
                }else if(obj.linkType == "special"){
                    $("#banner_hp").attr("href", "javascript:special;");
                }else if(obj.linkType == "news"){
                    $("#banner_hp").attr("href", "javascript:news;");
                } else if (obj.linkType == "none" && obj.url == null) {
                    $("#banner_hp").attr("href", "javascript:;");
                } else if(obj.linkType == "none" && obj.url != null){
                    $("#banner_hp").attr("href", obj.url);
                }else {
                    $("#banner_hp").attr("href", "javascript:;");
                }
                $("#banner_hp").find("img").attr("src", obj.image);
            }else {
                $("#banner_hp").css('display','none');
            }
        });
        hp.do(218);
        var key = cookie.getCookie('key');
        var mm=new member(function (data) {
            if(data.bindMobile=='binded'){
                $('#bindmobile').html(data.mobile);
                $('.bindphone').on('click',function () {
                    toast.show('您已绑定!');
                })
            }else{
                $('#bindmobile').html('未绑定');
                $('.bindphone').on('click',function () {
                    pageManager.go('bind');
                })
            };
            if(data.authStatus=='success'){
                $('#spread').html("已认证");
                $('.ifspread').removeAttr("href");
            }else if(data.authStatus=='wait'){
                $('.ifspread').removeAttr("href");
                $('#spread').html("认证中");
            }else{
                $('#spread').html("未认证");
            }
            $("#certi").click(function(){
                if(data.authStatus=='success'){
                    $('.ifspread').removeAttr("href");
                    toast.show("您已经实名认证");
                }else if(data.authStatus=='wait'){
                    $('.ifspread').removeAttr("href");
                    toast.show("正在审核，请耐心等待");
                }else{
                    pageManager.go('auth');
                }
            });
        });
        mm.view();
        if(key == 'ztb'){
            setTimeout(function () {
                $('.address_member').addClass('none');
                $('.key_login').addClass('none');
            },50)
        }

        //注册分享
        new member(function (data) {
            weixin.share({
                link:data.link
            })
        }).share();

        //数据处理
        //会员中心头像、用户名、等级、认证状态
        var mem = new member(function (data) {
            //订单列表角标如果是0的话就不显示
            if(data.unpaid==0){
                $("#unpaid").css("display",'none');
            }else if(data.unpaid > 99){
                $("#unpaid").css("display",'inline-block');
                $("#unpaid").addClass('badge');
                $("#unpaid").html('99+');
            }else {
                $("#unpaid").css("display",'inline-block');
                $("#unpaid").html(data.unpaid);
                $("#unpaid").addClass('badge');
            }
            if(data.unshipped==0){
                $("#unshipped").css("display",'none');
            }else if(data.unshipped > 99){
                $("#unshipped").css("display",'inline-block');
                $("#unshipped").addClass('badge');
                $("#unshipped").html('99+');
            }else {
                $("#unshipped").css("display",'inline-block');
                $("#unshipped").html(data.unshipped);
                $("#unshipped").addClass('badge');
            }
            if(data.unreciver==0){
                $("#unreciver").css("display",'none');
            }else if(data.unreciver > 99){
                $("#unreciver").css("display",'inline-block');
                $("#unreciver").addClass('badge');
                $("#unreciver").html('99+');
            }else {
                $("#unreciver").css("display",'inline-block');
                $("#unreciver").html(data.unreciver);
                $("#unreciver").addClass('badge');
            }
            if(data.unreview==0){
                $("#unreview").css("display",'none');
            }else if(data.unreview > 99){
                $("#unreview").css("display",'inline-block');
                $("#unreview").addClass('badge');
                $("#unreview").html('99+');
            }else {
                $("#unreview").css("display",'inline-block');
                $("#unreview").html(data.unreview);
                $("#unreview").addClass('badge');
            }
        });
        mem.index();
        //显示会员基本信息
        var mem1=new member(function(data){
            var employId=data.employeeId;
            var memid=data.id;

            //实名认证的判断
            if(data.authStatus!='success'){
                $('#ifauth').removeClass('bigv').addClass('bigr');
            }

            //进入收藏
            $('.memberNew .fguide').on('click',function () {
                pageManager.go('favoriteGuide');
            });
            $('.memberNew .fproduct').on('click',function () {
                pageManager.go('favoriteProduct');
            });

//            $('#seeInfo .weui-cell__bd').on('click',function () {
            $('.member-top .image').on('click',function () {
                if(data.guide==true){
                    location.href=location.origin+'/weixin/guide/home.html?id='+employId+'&mid='+memid+'&who=me&userType=guide';
                }else if(data.guide==false&&data.partnerStatus=='success'){
                    location.href=location.origin+'/weixin/guide/home.html?id='+employId+'&mid='+memid+'&who=me&userType=simple';
                }else{
                    location.href=location.origin+'/weixin/guide/edit.html?id='+memid;
                }
            });
        });
        mem1.view();


        //我的钱包
        if(window.location.hash=='#purseIndex'){
            document.title='我的钱包';
            var balance=new member(function(data){
                $('.purse_amount #balance').html(data.balance);
                $(".purse_info #canget").html(data.balance);
                $(".purse_info .freezeBalance").html(data.freezeBalance);
            });
            balance.balance();
            //跳转银行卡页面，判断是否实名，实名后才能跳转
            $('.gotomybank').click(function(){
                var m=new member(function(data){
                    if(data.authStatus=='success'){
                        pageManager.go('bank');
                    }else{
                        dialog.show("实名认证后才可使用此功能!");
                    }
                });
                m.index();
            });
            //跳转提现页面，判断是否实名，实名后才能跳转
            $('#gotocash').click(function(){
                var m=new member(function(data){
                    if(data.authStatus=='success'){
                        pageManager.go('cash');
                    }else{
                        dialog.show("实名认证后才可使用此功能!");
                    }
                });
                m.index();
            });
        }

        //消息
        if(window.location.hash=='#message'){
            document.title='消息';

            $('.chatlist').html('');

            //典型消息显示第一个
            var m=new message(function (data) {
                if(data.order != null || data.order != ""){
                    $(".firstodmes").html(data.order);
                }
            });
            m.firstMessage();
            var me=new message(function (data) {
                if(data.account != null || data.account != ""){
                    $(".firstblmes").html(data.account);
                }
            });
            me.firstMessage();
            var ms=new message(function (data) {
                if(data.message != null || data.message != ""){
                    $(".firstsymes").html(data.message);
                }
            });
            ms.firstMessage();

                var co=new message(function (data) {
                    if(data.order!=0){
                        $('.countorder').removeClass('none');
                    }
                    if(data.account!=0){
                        $('.countbill').removeClass('none');
                    }
                    if(data.message!=0){
                        $('.countsys').removeClass('none');
                    };
                });
                co.count();


            function getCurrentDb() {
                //打开数据库，或者直接连接数据库参数：数据库名称，版本，概述，大小
                //如果数据库不存在那么创建之
                var db = openDatabase("ch515at", "1.0", "it's to save chatGuide data!", 1024 * 1024); ;
                return db;
            }
            //显示所有数据库中的数据到页面上去
            function showAllTheData() {
                var db = getCurrentDb();
                db.transaction(function (trans) {
                    trans.executeSql("select gid,mescont,mestime,txttype from chatGuide group by gid order by mestime desc", [], function (ts, data) {
                        if (data) {
                            for (var i = 0; i < data.rows.length; i++) {
                                appendDataToTable(data.rows.item(i));//获取某行数据的json对象
                            }
                        }
                    }, function (ts, message) {
                        var tst = message;});
                });
            }
            //删除数据库中的聊天记录
            function deleteMysql(memberId) {
                var db = getCurrentDb();
                db.transaction(function (trans) {
                    trans.executeSql("delete from chatGuide where gid=="+memberId, [], function (ts, data) {
                    }, function (ts, message) {
                        var tst = message;});
                });
            }
            function appendDataToTable(data) {//将数据展示到表格里
                //idGuide,mType,mCount,mTime
                var idGuide=data.gid;
                var mType = data.mestype;
                var mCount = data.mescont;
                var mTime = data.mestime;
                var tType=data.txttype;
                //最后一条消息的时间
                var dMonth=mTime.substring(4,6);
                var dDate=mTime.substring(6,8);
                var dHour=mTime.substring(8,10);
                var dMinute=mTime.substring(10,12);
                var dSecond=mTime.substring(12,14);
                var nchatTime=dMonth+'-'+dDate+'  '+dHour+':'+dMinute+':'+dSecond;
                if(tType=='couponList' || tType=='coupon'){
                    mCount='[分享现金券]';
                }else if(tType=='product'){
                    mCount='[分享商品]';
                }else if(tType=='redPacket' || tType=='redPacketList'){
                    mCount='[分享红包]';
                }else if(tType=='audio'){
                    mCount='[语音]';
                }else if(tType=='img'){
                    mCount='[图片]';
                }else if(tType=='tenantCoupon'){
                    mCount='[分享优惠券]';
                }else if(tType=='location'){
                    mCount='[位置消息]';
                }
                function html_encode(str)
                {
                    var s = "";
                    if (str.length == 0) return "";
                    s = str.replace(/&/g, "&amp;");
                    s = s.replace(/</g, "&lt;");
                    s = s.replace(/>/g, "&gt;");
                    s = s.replace(/ /g, "&nbsp;");
                    s = s.replace(/\'/g, "&#39;");
                    s = s.replace(/\"/g, "&quot;");
                    return s;
                }
                var lhtml='';
                lhtml+='<div class="line-wrapper">'+
                    '<div class="line-scroll-wrapper">'+
                    '<a  class="goChat" style="cursor:pointer;" id='+idGuide+' >'+
                    '<div class="line-normal-wrapper">'+
                    '<div class="line-normal-left-wrapper">'+
                    '<div class="line-normal-avatar-wrapper"><img  class="headImg" src="" /></div>'+
                    '<div class="line-normal-info-wrapper">'+
                    '<div class="line-normal-user-name name f14 overone"></div>'+
                    '<div class="line-normal-msg clr_lightGray f12">'+html_encode(mCount)+'</div>'+
                    '</div>'+
                    '<div class="line-normal-time f12">'+nchatTime+'</div>'+
                    '</div>'+
                    '<div class="line-normal-icon-wrapper"></div>'+
                    '</div>'+
                    '</a>'+
                    '<div class="line-btn-delete f14" id='+idGuide+'><button>删除</button></div>'+
                    '</div>'+
                    '</div>';
                $('.chatlist').append(lhtml);
                $(document).on('click','.goChat',function () {
                    var mid=$(this).attr('id');
                    new member(function (data) {
                        location.href=location.origin+'/weixin/guide/chat.html?mid='+mid;
                    }).addConversation({id:mid})
                })
            }
            showAllTheData();
            setTimeout(function () {
                $('.chatlist a').each(function () {
                    var $this=$(this);
                    var tid=$this.attr('id');
                    new member(function (data) {

                        var guidename=data.displayName;
                        var headImg=data.headImg;
                        $this.find('.name').html(guidename);
                        if(headImg==null){
                            $this.find('.headImg').attr('src','../images/static/guide/dmLogo.png');
                        }else{
                            $this.find('.headImg').attr('src',headImg);
                        }
                    }).view({
                        id: tid
                    });
                });
                // 设定每一行的宽度=屏幕宽度+按钮宽度
                $(".line-scroll-wrapper").width($(".line-wrapper").width() + $(".line-btn-delete").width());
                // 设定常规信息区域宽度=屏幕宽度
                $(".line-normal-wrapper").width($(".line-wrapper").width());
                // 设定文字部分宽度（为了实现文字过长时在末尾显示...）
                $(".line-normal-msg").width($(".line-normal-wrapper").width() - 280);
                // 获取所有行，对每一行设置监听
                var lines = $(".line-normal-wrapper");
                var len = lines.length;
                var lastX, lastXForMobile;
                // 用于记录被按下的对象
                var pressedObj;  // 当前左滑的对象
                var lastLeftObj; // 上一个左滑的对象
                // 用于记录按下的点
                var start;
                // 网页在移动端运行时的监听
                for (var i = 0; i < len; ++i) {
                    lines[i].addEventListener('touchstart', function(e){
                        lastXForMobile = e.changedTouches[0].pageX;
                        pressedObj = this; // 记录被按下的对象
                        // 记录开始按下时的点
                        var touches = event.touches[0];
                        start = {
                            x: touches.pageX, // 横坐标
                            y: touches.pageY  // 纵坐标
                        };
                    });
                    lines[i].addEventListener('touchmove',function(e){
                        // 计算划动过程中x和y的变化量
                        var touches = event.touches[0];
                        delta = {
                            x: touches.pageX - start.x,
                            y: touches.pageY - start.y
                        };
                        // 横向位移大于纵向位移，阻止纵向滚动
                        if (Math.abs(delta.x) > Math.abs(delta.y)) {
                            event.preventDefault();
                        }
                    });
                    lines[i].addEventListener('touchend', function(e){
                        if (lastLeftObj && pressedObj != lastLeftObj) { // 点击除当前左滑对象之外的任意其他位置
                            $(lastLeftObj).animate({marginLeft:"0"}, 100); // 右滑
                            lastLeftObj = null; // 清空上一个左滑的对象
                        }
                        var diffX = e.changedTouches[0].pageX - lastXForMobile;
                        if (diffX < -15) {
                            $(pressedObj).animate({marginLeft:"-75px"}, 200); // 左滑
                            lastLeftObj && lastLeftObj != pressedObj &&
                            $(lastLeftObj).animate({marginLeft:"0"}, 500); // 已经左滑状态的按钮右滑
                            lastLeftObj = pressedObj; // 记录上一个左滑的对象
                        } else if (diffX > 50) {
                            if (pressedObj == lastLeftObj) {
                                $(pressedObj).animate({marginLeft:"0"}, 500); // 右滑
                                lastLeftObj = null; // 清空上一个左滑的对象
                            }
                        }
                    });
                }
                $('.line-btn-delete').on('click',function () {
                    var mid=$(this).attr('id');
                    deleteMysql(mid);
                    $(this).parent().parent().remove();
                })
            },1000)
        }

        //订单消息
        if(window.location.hash=='#orderMes'){
            document.title='订单消息';
            var pge = $(".orderMes .pageable").pageable({
                scrollFn:function () {
                    $(window).trigger('scroll');
                },
                loadUpFn:function(me) {
                    var tu = new message(function (data) {
                        var h = render.fill($("#tpl_orderMessage"),data);
                        $(".pageable .ordermes").html(h);
                        $('img').picLazyLoad();
                        pge.resetload();
                    });
                    tu.orderList({type:"order",pageNumber: 1});
                },
                loadDownFn :function(me) {
                    var td = new message(function (data) {
                        pge.pageNumber = me.pageNumber +1;
                        var h = render.fill($("#tpl_orderMessage"),data);
                        $(".pageable .ordermes").append(h);
                        $('img').picLazyLoad();
                        if (data.length<20){
                            pge.lock();
                            pge.noData();
                        }
                        pge.resetload();
                    });
                    td.orderList({type:"order",pageNumber: me.pageNumber});
                }}
            );
        }

        //账单消息
        if(window.location.hash=='#billMes'){
            document.title='账单消息';
            if(!$(".pageable .billes").hasClass('hasPageable')){
                var pge = $(".billMes .pageable").pageable({
                        loadUpFn:function(me) {
                            var tu = new message(function (data) {
                                var h = render.fill($("#tpl_billMessage"),data);
                                $(".pageable .billes").html(h);
                                pge.resetload();
                            });
                            tu.list({type:"account",pageNumber: 1});
                        },
                        loadDownFn :function(me) {
                            var td = new message(function (data) {
                                pge.pageNumber = me.pageNumber +1;
                                var h = render.fill($("#tpl_billMessage"),data);
                                $(".pageable .billes").append(h);
                                $(".pageable .billes").addClass('hasPageable');
                                if (data.length<20){
                                    pge.lock();
                                    pge.noData();
                                }
                                pge.resetload();
                            });
                            td.list({type:"account",pageNumber: me.pageNumber});
                        }
                    }
                );
            }
//            $(document).on('click','.gobillms',function () {
//                location.href=location.origin+'/weixin/member/index.html#bill-list';
//            })

        }

        //系统消息
        if(window.location.hash=='#systemMes'){
            document.title='系统消息';
            var pge = $(".systemMes .pageable").pageable({
                    loadUpFn:function(me) {
                        var tu = new message(function (data) {
                            var h = render.fill($("#tpl_systemMessage"),data);
                            $(".pageable .symes").html(h);
                            pge.resetload();
                        });
                        tu.list({type:"message",pageNumber: 1});
                    },
                    loadDownFn :function(me) {
                        var td = new message(function (data) {
                            pge.pageNumber = me.pageNumber +1;
                            var h = render.fill($("#tpl_systemMessage"),data);
                            $(".pageable .symes").append(h);
                            if (data.length<20){
                                pge.lock();
                                pge.noData();
                            }
                            pge.resetload();
                        });
                        td.list({type:"message",pageNumber: me.pageNumber});
                    }
                }
            );
        }

        //收藏导购
        if(window.location.hash=='#favoriteGuide'){
            document.title='关注的人';
            //收藏导购
            var pgeg = $(".favoriteGuide .pageable").pageable({
                scrollFn:function () {
                    $(window).trigger('scroll');
                },
                loadUpFn:function(me) {
                    var tu = new favorite(function (data) {
                        var h = render.fill($("#tpl_shopGuideTemp"),data);
                        $(".pageable .mycolguide").html(h);
                        $('img').picLazyLoad();
                        me.resetload();
                    });
                    tu.guideList({pageNumber: 1});
                },
                loadDownFn :function(me) {
                    var td = new favorite(function (data) {
                        me.pageNumber = me.pageNumber +1;
                        var h = render.fill($("#tpl_shopGuideTemp"),data);
                        $(".pageable .mycolguide").append(h);
                        $('img').picLazyLoad();
                        if (data.length<20){
                            me.lock();
                            me.noData();
                        }
                        me.resetload();
                    });
                    td.guideList({pageNumber: me.pageNumber});
                }
            });

            $(document).on('click','.chatsList',function () {
                var mid=$(this).attr('data-id');
                new member(function (data) {
                    location.href=location.origin+'/weixin/guide/chat.html?mid='+mid;
                }).addConversation({id:mid})
            });

        }

        //收藏商家
        if(window.location.hash=='#favoriteTenant'){
            document.title='收藏店铺';
            var pged = $(".favoriteTenant .pageable").pageable({
                scrollFn:function () {
                    $(window).trigger('scroll');
                },
                loadUpFn:function(me) {
                    var tu = new favorite(function (data) {
                        var h = render.fill($("#tpl_tenantList"),data);
                        $(".pageable .collshop").html(h);
                        $('img').picLazyLoad();
                        me.resetload();
                    });
                    tu.tenantList({pageNumber: 1});
                },
                loadDownFn :function(me) {
                    var td = new favorite(function (data) {
                        me.pageNumber = me.pageNumber +1;
                        var h = render.fill($("#tpl_tenantList"),data);
                        $(".pageable .collshop").append(h);
                        $('img').picLazyLoad();
                        if (data.length<20){
                            me.lock();
                            me.noData();
                        }
                        me.resetload();
                    });
                    td.tenantList({pageNumber: me.pageNumber});
                }
            });
        }

        //收藏商品
        if(window.location.hash=='#favoriteProduct'){
            document.title='收藏商品';
//        tabBar.bind();
            //收藏商品
            var pged = $(".favoriteProduct .pageable").pageable({
                scrollFn:function () {
                    $(window).trigger('scroll');
                },
                loadUpFn:function(me) {
                    var tu = new favorite(function (data) {
                        var h = render.fill($("#tpl_productList"),data);
                        $(".pageable .product-grid").html(h);
                        $('img').picLazyLoad();
                        me.resetload();
                    });
                    tu.productList({pageNumber: 1});
                },
                loadDownFn :function(me) {
                    var td = new favorite(function (data) {
                        me.pageNumber = me.pageNumber +1;
                        var h = render.fill($("#tpl_productList"),data);
                        $(".pageable .product-grid").append(h);
                        $('img').picLazyLoad();
                        if (data.length<20){
                            me.lock();
                            me.noData();
                        }
                        me.resetload();
                    });
                    td.productList({pageNumber: me.pageNumber});
                }
            });
        }

        //收藏文章
        if(window.location.hash=='#favoriteNew'){
            document.title='收藏文章';
            var pged = $(".favoriteNew .pageable").pageable({
                loadUpFn:function(me) {
                    var tu = new favorite(function (data) {
                        var h = render.fill($("#tpl_articleList"),data);
                        $(".pageable .news_list").html(h);
                        me.resetload();
                    });
                    tu.articleList({pageNumber: 1});
                },
                loadDownFn :function(me) {
                    var td = new favorite(function (data) {
                        me.pageNumber = me.pageNumber +1;
                        var h = render.fill($("#tpl_articleList"),data);
                        $(".pageable .news_list").append(h);
                        if (data.length<20){
                            me.lock();
                            me.noData();
                        }
                        me.resetload();
                    });
                    td.articleList({pageNumber: me.pageNumber});
                }
            });
        }



        //提现到银行卡
        if(window.location.hash=='#cashBank'){
            $('.getcash').val('');
            $('.tip').html(0.00);
            $('.trueamount').html('');
            document.title='提现到银行卡';
            new bank(function (data) {
                $('.user_getcash_bank #selbank').html(data[0].bankName+'('+data[0].cardNo+')');
                $('.user_getcash_bank #selbank').attr('bankid',data[0].id);
                $('.user_getcash_bank #logo').attr('src',data[0].logo);
            }).list();
            $(document).ready(function () {
                var h=$(window).height();
                $(window).resize(function() {
                    if($(window).height()<h){
                        $('.weui-btn-area').hide();
                        $('.cashpay').addClass('payed').removeClass('paying');
                    }
                    if($(window).height()>=h){
                        $('.weui-btn-area').show();
                        $('.cashpay').addClass('paying').removeClass('payed');
                    }
                });
            });
            //选择我的银行卡
            $("#choosemybanks").click(function () {
                $('.user_getcash_bank').hide();
                choosemybank.bank();
                choosemybank.callBack=function (bank) {
                    $('#selbank').css('color',"#333").css('opacity',"1");
                    $("#selbank").html(bank.name+'('+bank.cardNo+')');
                    $("#selbank").attr('bankid',bank.id);
                    $('.user_getcash_bank #logo').attr('src',bank.logo);
                    $('.user_getcash_bank').css('display','block');
                };
            });
            //显示当前余额
            var me=new member(function(data){
                var canCash='可转出到卡'+data.withdrawBalance+'元';
                $('.user_getcash_bank .getcash').attr('placeholder',canCash);
            });
            me.balance();
            //根据提现金额计算手续费并显示
            $('.cashBank .getcash').change(function(){
                var getcash=$('.cashBank .getcash').val();  //提现金额
                var me=new member(function(data){
                    $('.cashBank .tip').html(data);//手续费
                    $('.cashBank .trueamount').html(getcash-data); //实际到账金额
                });
                me.calcFee({amount:getcash?getcash:0});
            });
            //提交后弹开密码框
            var $iosMask = $('.user_getcash_bank #iosMask');
            function hideActionSheet() {
                $iosMask.fadeOut(200);
                $('.cashpay').css("display", 'none');
            }
            $iosMask.on('click', hideActionSheet);
            var clicktag = 0;
            $('.user_getcash_bank .section3').click(function(){
                if (clicktag == 0) {
                    clicktag = 1;
                    if($("#selbank").val()==''){
                        toast.show('请选择银行');
                    }else if($(".cashBank .getcash").val()==''){
                        toast.show('请输入提现金额');
                    }else{
                        $('.user_getcash_bank .cashpay').css("display",'block');
                        $('.user_getcash_bank #pwd-input').focus();
                        new member(function (data) {
                            if (data.paymentPassword) {     //是否设置了支付密码
                                $iosMask.fadeIn(200);
                                $('.chooseWidget').hide();
                                $("#cashmoney").html($(".cashBank .getcash").val());   //同步到密码框里面的金额
                            }else{
                                $('input[type="tel"]').blur();
                                $('.cashpay').css("display", 'none');
                                dialog.show('请先设置支付密码');
                                setTimeout(function () {
                                    location.href=location.origin+'/weixin/payment/payPassword.html';
                                },2000);
                            }
                        }).passwordSet();
                    }
                    setTimeout(function () { clicktag = 0 }, 2000);
                }else{
                    toast.show('点击太频繁！');
                }
            });
            //按钮关闭密码框
            $(".user_getcash_bank .icon-remove-02").click(function(){
                $iosMask.fadeOut(200);
                $('.user_getcash_bank .cashpay').css("display",'none');
            });
            //密码框js控制
            var $input = $(".user_getcash_bank .fake-box input");
            $(".user_getcash_bank #pwd-input").off().on("input", function() {
                console.log(111)
                var pwd = $(this).val().trim();
                for (var i = 0, len = pwd.length; i < len; i++) {
                    $input.eq("" + i + "").val(pwd[i]);
                }
                document.onkeydown=function(event){
                    var e = event || window.event || arguments.callee.caller.arguments[0];
                    if(e && e.keyCode==8){ // enter 键
                        //要做的事情
                        $("#pwd-input").val('');
                        $(".fake-box input").val('');
                    }
                };
                $input.each(function() {
                    var index = $(this).index();
                    if (index >= len) {
                        $(this).val("");
                    }
                });
                if (len == 6) {
                    //密码到达6位数后执行接口
                    var bankid=$('#selbank').attr('bankid');   //银行卡id
                    var amount=$(".cashBank .getcash").val();            //提现数额
                    var cm=new common(function (data){
                        var rsaKey = new RSAKey();
                        rsaKey.setPublic(b64tohex(data.modulus), b64tohex(data.exponent));
                        var enPassword = hex2b64(rsaKey.encrypt(pwd));
                        var me=new member(function(data){
                            $('input[type="tel"]').blur();
                            $('.user_getcash_bank .cashpay').css("display",'none');
                            dialog.show("提现成功");
                            setTimeout(function (){
                                pageManager.back();
                            },1000);
                        });
                        me.cash({memberBankId:bankid,amount:amount,enPassword:enPassword})
                    });
                    cm.getPublicKey();
                    $('.weui-dialog').css('top','65%');
                }
            });

        }

        //提现到微信钱包
        if(window.location.hash=='#cashWeixin'){
            $('.getcash').val('');
            $('.tip').html(0.00);
            $('.trueamount').html('');
            document.title='提现到微信';
            $(document).ready(function () {
                var h=$(window).height();
                $(window).resize(function() {
                    if($(window).height()<h){
                        $('.weui-btn-area').hide();
                        $('.cashpay').addClass('payed').removeClass('paying');
                    }
                    if($(window).height()>=h){
                        $('.weui-btn-area').show();
                        $('.cashpay').addClass('paying').removeClass('payed');
                    }
                });
            });
            $(document).on('click','.pursecashbank',function () {
                new member(function (data) {
                    if(data.authStatus=='success'){
                        pageManager.replace('cashBank')

//                        location.replace(location.origin+'/weixin/member/index.html?hash='+(+new Date())+'#cashBank');
                    }else{
                        dialog.show('实名认证通过后可转出到银行卡');
                        setTimeout(function () {
                            pageManager.go('auth')
//                            location.href=location.origin+'/weixin/member/index.html#auth'
                        },2000)
                    }
                }).view();
            });
            //显示当前余额
            var me=new member(function(data){
                var canCash='可转出到微信'+data.withdrawBalance+'元';
                $('.user_getcash_weixin .getcash').attr('placeholder',canCash);
            });
            me.balance();
            //根据提现金额计算手续费并显示
            $('.cashWeixin .getcash').change(function(){
                var getcash=$('.cashWeixin .getcash').val();  //提现金额
                var me=new member(function(data){
                    $('.cashWeixin .tip').html(data);//手续费
                    $('.cashWeixin .trueamount').html(getcash-data); //实际到账金额
                });
                me.calcFee({amount:getcash?getcash:0});
            });
            //提交后弹开密码框
            var $iosMask = $('.user_getcash_weixin #iosMask');
            function hideActionSheet() {
                $iosMask.fadeOut(200);
                $('.cashpay').css("display", 'none');
            }
            $iosMask.on('click', hideActionSheet);
            var clicktag = 0;
            $('.user_getcash_weixin .section3').click(function(){
                if (clicktag == 0) {
                    clicktag = 1;
                    if($(".cashWeixin .getcash").val()==''){
                        toast.show('请输入提现金额');
                    }else if(parseInt($(".cashWeixin .getcash").val())<2){
                        toast.show('最少提现2元');
                    }else{
                        $('.user_getcash_weixin .cashpay').css("display",'block');
                        $('input[type="tel"]').focus();
                        new member(function (data) {
                            if (data.paymentPassword) {     //是否设置了支付密码
                                $iosMask.fadeIn(200);
                                $('.chooseWidget').hide();
                                $("#cashmoney").html($(".cashWeixin .getcash").val());   //同步到密码框里面的金额
                            }else{
                                $('input[type="tel"]').blur();
                                $('.cashpay').css("display", 'none');
                                dialog.show('请先设置支付密码');
                                setTimeout(function () {
                                    location.href=location.origin+'/weixin/payment/payPassword.html';
                                },2000);
                            }
                        }).passwordSet();
                    }
                    setTimeout(function () { clicktag = 0 }, 2000);
                }else{
                    toast.show('点击太频繁！');
                }
            });
            //按钮关闭密码框
            $(".user_getcash_weixin .icon-remove-02").click(function(){
                $iosMask.fadeOut(200);
                $('.user_getcash_weixin .cashpay').css("display",'none');
            });
            //密码框js控制
            var $input = $(".user_getcash_weixin .fake-box input");
            $(".user_getcash_weixin #pwd-input").off().on("input", function() {
                var pwd = $(this).val().trim();
                for (var i = 0, len = pwd.length; i < len; i++) {
                    $input.eq("" + i + "").val(pwd[i]);
                }
                document.onkeydown=function(event){
                    var e = event || window.event || arguments.callee.caller.arguments[0];
                    if(e && e.keyCode==8){ // enter 键
                        //要做的事情
                        $("#pwd-input").val('');
                        $(".fake-box input").val('');
                    }
                };
                $input.each(function() {
                    var index = $(this).index();
                    if (index >= len) {
                        $(this).val("");
                    }
                });
                if (len == 6) {
                    //密码到达6位数后执行接口
                    var bankid=$('#selbank').attr('bankid');   //银行卡id
                    var amount=$(".cashWeixin .getcash").val();//提现数额
                    var cm=new common(function (data){
                        var rsaKey = new RSAKey();
                        rsaKey.setPublic(b64tohex(data.modulus), b64tohex(data.exponent));
                        var enPassword = hex2b64(rsaKey.encrypt(pwd));
                        var me=new member(function(data){
                            $('input[type="tel"]').blur();
                            $('.user_getcash_weixin .cashpay').css("display",'none');
                            dialog.show("提现成功");
                            setTimeout(function (){
                                pageManager.back();
                            },1000);
                        });
                        me.cash2wx({amount:amount,enPassword:enPassword})
                    });
                    cm.getPublicKey();
                    $('.weui-dialog').css('top','65%');
                }
            });
        }

        //充值页面
        if(window.location.hash=='#charge'){
            document.title='充值';
            $(document).ready(function () {
                var h=$(window).height();
                $(window).resize(function() {
                    if($(window).height()<h){
                        $('.weui-btn-area').hide();
                    }
                    if($(window).height()>=h){
                        $('.weui-btn-area').show();
                    }
                });
            });
            //提交充值的余额
            $('.purse_charge .section3 .weui-btn-area a').click(function () {
                var amount = $('.purse_charge #amount').val();
                var payStyleId=$('.purse_charge .chargePay').attr('styleid');
                //微信支付
                if(payStyleId=='weixin'){
                    var me = new member(function (charge) {
                        var paySn=charge;
                        new order(function (data) {
                            function onBridgeReady() {
                                WeixinJSBridge.invoke(
                                    'getBrandWCPayRequest', {
                                        "appId": data.appId,
                                        "timeStamp": data.timeStamp,
                                        "nonceStr": data.nonceStr,
                                        "package": data.package,
                                        "signType": data.signType,
                                        "paySign": data.paySign
                                    },
                                    function (res) {
                                        if (res.err_msg == "get_brand_wcpay_request:ok") {
                                            //支付成功
                                            location.replace(location.origin+'/weixin/payment/pay.html?sn='+paySn+'#paySuccess');
                                        } else {
                                            //支付失败
                                            dialog.show('付款失败，请重试');
                                        }
                                    }
                                );
                            }
                            if (typeof WeixinJSBridge == "undefined") {
                                if (document.addEventListener) {
                                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                                } else if (document.attachEvent) {
                                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                                }
                            } else {
                                onBridgeReady();
                            }
                        }).paymentSubmit({
                            paymentPluginId: "weixinPayPlugin",
                            sn: paySn
                        });
                    });
                    me.fill({amount: amount});
                    //银行卡充值支付
                }else{
                    toast.show('暂未开通银行卡付款!');
                }
            });
        }

        //我的银行卡
        if(window.location.hash=='#bank'){
            var td = new bank(function (data) {
                var h = render.fill($("#tpl_bankList"),data);
                $(".mybankcart").append(h);
                //删除银行卡
                $(".deletecard").click(function() {
                    var cardid = $(this).parent().parent().attr("id");
                    dialog.query("您确认删除该银行卡吗？", function () {
                        var ba = new bank(function (data) {
                            dialog.show("删除成功");
                            setTimeout(function () {
                                location.reload();
                            }, 1000);
                        });
                        ba.delete({id: cardid});
                    })
                })
            });
            td.list({pageNumber:1});
        }

        //添加银行卡
        if(window.location.hash=='#addBank'){
            var countdown=60;
            function settime(val) {
                if (countdown == 0) {
                    val.removeAttribute("disabled");
                    val.value="发送验证码";
                    val.style.background="#00a0e9";
                    countdown = 60;
                    return;
                } else {
                    val.setAttribute("disabled", true);
                    val.value="重新发送(" + countdown + ")";
                    val.style.background="#999";
                    countdown--;
                }
                setTimeout(function() {
                    settime(val)
                },1000)
            }
            $(function () {
                document.title='添加银行卡';

                $("#choosebank").click(function () {
                    choosebank.bank();
                    choosebank.callBack=function (bank) {
                        $("#bankName").text(bank.name);
                        $("#bankName").attr('bankid',bank.id)
                    };
                });
                //添加卡
                $("#addbank").click(function(){
                    var check=document.getElementById('weuiAgree');
                    var bankid=$("#bankName").attr('bankid');
                    var cardnum=$("#cardnum").val();
                    var name=$("#name").val();
                    var idcard=$("#idcard").val();
                    var phonenumber=$("#phonenumber").val();
                    var validate=$("#validate").val();
                    if(!bankid){
                        toast.show('请选择银行卡');
                    }else if(cardnum==''||name==''||idcard==''||phonenumber==''||validate==''){
                        toast.show('请填写信息完整');
                    }else if(check.checked==true){
                        var ba=new bank(function(data){
                            dialog.show("添加成功");
                            setTimeout(function () {
                                pageManager.back();
                            },1000);
                        });
                        ba.save({captcha:validate,bankInfoId:bankid,cardNo:cardnum,depositUser:name,idCardNo:idcard});

                    }else{
                        toast.show('请同意服务协议')
                    }
                });
                //获取验证码
                $("#getvalidate").on('click',function (){
                    var $this=this;
                    var phonenum=$("#phonenumber").val();
                    if((!(/^1[34578]\d{9}$/.test(phonenum)))){
                        toast.show('请输入正确手机号码！')
                    } else{
                        var ba = new bank(function (data) {
                            settime($this);
                            toast.show("已发送");
                        });
                        ba.sendCode({mobile: phonenum})
                    }
                })
            });
        }

        //我的账单
        if(window.location.hash=='#billList'){
            document.title='账单';
            //(账单与明细)选项卡切换
            $('.weui-navbar__item').on('click', function () {
                $(this).addClass('active').siblings().removeClass('active');
                $(this).css("color",'red').siblings().css('color','#000');
                $(this).parent().parent().children().eq($(this).index()+1).css("display","block").siblings('.weui-tab__panel').css("display","none")
            });
            //获取当前年月
            var date=new Date;
            var year=date.getFullYear();
            var month=date.getMonth()+1;
            month =(month<10 ? "0"+month:month);
            var mydate = (year.toString()+'-'+month.toString());
            var nowyear=year.toString();
            var nowmonth=month.toString();
            $("#z1").html(nowyear);
            $("#z2").html(nowmonth);
            var nowdate;
            nowdate=mydate+'-01'+' '+'00:00:00';  //开始时间为当前月份第一天零点
            //默认显示当前月份账单明细
            var jsons={begin_date:nowdate,pageNumber:1};
            var loadUpFn = function () {
                jsons.pageNumber=1;
                var tu = new deposit(function (data) {
                    jsons.pageNumber+=1;
                    var str='';
                    for(var i=0;i<data.length;i++){
                        str +='<div class="weui-cell ">'+
                            '<div class="weui-cell__hd f14">'
                        if(data[i].type=='recharge'){
                            str+='<p>充值</p>';
                        }else if(data[i].type=='payment'){
                            str+='<p>购物</p>';
                        }else if(data[i].type=='withdraw'){
                            str+='<p>提现</p>';
                        }else if(data[i].type=='receipts'){
                            str+='<p>货款</p>';
                        }else if(data[i].type=='profit'){
                            str+='<p>分润</p>';
                        }else if(data[i].type=='rebate'){
                            str+='<p>佣金</p>';
                        }else if(data[i].type=='cashier'){
                            str+='<p>收款</p>';
                        }else if(data[i].type=='income'){
                            str+='<p>收入</p>';
                        }else if(data[i].type=='outcome'){
                            str+='<p>支出</p>';
                        }else if(data[i].type=='coupon'){
                            str+='<p>红包</p>';
                        };
                        str+='</div>';
                        str+='<div class="weui-cell__bd weui-cell__primary f12">'+
                            '<p style="margin-top:1px;">'+data[i].memo+'</p>'+
                            '<p>'+data[i].create_date+'</p>'+
                            '</div>';
                        str+='<div class="weui-cell__ft f12 clr_orange">';
                        if(data[i].credit==0 && data[i].debit=='0'){
                            str+='<p>+￥0</p>';
                        }else if(data[i].credit==0 && data[i].debit!='0'){
                            if(data[i].debit<0){
                                str+='<p>+￥'+Math.abs(data[i].debit)+'</p>';
                            }else{
                                str+='<p>-￥'+data[i].debit+'</p>';
                            }
                        }else if(data[i].credit!=0 && data[i].debit=='0'){
                            str+='<p>+￥'+data[i].credit+'</p>';
                        }
                        str+='<p>'+data[i].balance+'</p>'+
                            '</div>';
                        str+='</div>';
                    }

                    $(".pageable .billdt").html(str);
                    pge2.resetload();
                });
                tu.list(jsons);
            }
            var pge2 = $(".billList .pageable").pageable({
                    loadUpFn:loadUpFn,
                    loadDownFn :function () {
                        var td = new deposit(function (data) {
                            jsons.pageNumber+=1;
                            for(var i=0;i<data.length;i++){
                                var str='';
                                str +='<div class="weui-cell ">'+
                                    '<div class="weui-cell__hd f14">'
                                if(data[i].type=='recharge'){
                                    str+='<p>充值</p>';
                                }else if(data[i].type=='payment'){
                                    str+='<p>购物</p>';
                                }else if(data[i].type=='withdraw'){
                                    str+='<p>提现</p>';
                                }else if(data[i].type=='receipts'){
                                    str+='<p>货款</p>';
                                }else if(data[i].type=='profit'){
                                    str+='<p>分润</p>';
                                }else if(data[i].type=='rebate'){
                                    str+='<p>佣金</p>';
                                }else if(data[i].type=='cashier'){
                                    str+='<p>收款</p>';
                                }else if(data[i].type=='income'){
                                    str+='<p>收入</p>';
                                }else if(data[i].type=='outcome'){
                                    str+='<p>支出</p>';
                                }else if(data[i].type=='coupon'){
                                    str+='<p>红包</p>';
                                };
                                str+='</div>';
                                str+='<div class="weui-cell__bd weui-cell__primary f12">'+
                                    '<p style="margin-top:1px;">'+data[i].memo+'</p>'+
                                    '<p>'+data[i].create_date+'</p>'+
                                    '</div>';

                                str+='<div class="weui-cell__ft f12 clr_orange">';

                                if(data[i].credit==0 && data[i].debit=='0'){
                                    str+='<p>+￥0</p>';
                                }else if(data[i].credit==0 && data[i].debit!='0'){
                                    if(data[i].debit<0){
                                        str+='<p>+￥'+Math.abs(data[i].debit)+'</p>';
                                    }else{
                                        str+='<p>-￥'+data[i].debit+'</p>';
                                    }
                                }else if(data[i].credit!=0 && data[i].debit=='0'){
                                    str+='<p>+￥'+data[i].credit+'</p>';
                                }
                                str+='<p>'+data[i].balance+'</p>'+
                                    '</div>';
                                str+='</div>';
                                $(".pageable .billdt").append(str);
                            }
//                            var h = render.fill($("#tpl_bills"),data);
//                            $(".pageable .billdt").append(h);
                            if (data.length<20){
                                pge2.lock();
                                pge2.noData();
                            }
                            pge2.resetload();
                        });
                        td.list(jsons);
                    }
                }
            );

            //默认显示当前月份账单统计
            var de=new deposit(function(data){
                $("#total_income").html(data.total_income);                                        //总收入
                $("#total_outcome").html(data.total_outcome);                                      //总支出
                $("#receipts").html(data.receipts);                                                //货款收入
                var receipts=Math.round(data.receipts/data.total_income * 10000)/100.00;
                $(".receipts").html(receipts);                                                      //货款收入百分比
                if(receipts!=0){
                    $(".receipts").parent().next('div').width(receipts+'%');
                }else{
                    $(".receipts").parent().next('div').addClass('none');
                }

                $("#profit").html(data.profit);                                                    //分润收入
                var profit=Math.round(data.profit/data.total_income * 10000)/100.00;
                $(".profit").html(profit);                                                          //分润收入百分比
                if(profit!=0){
                    $(".profit").parent().next('div').width(profit+'%');
                }else{
                    $(".profit").parent().next('div').addClass('none');
                }

                $("#rebate").html(data.rebate);                                                    //佣金支出
                var rebate=Math.round(data.rebate/data.total_outcome * 10000)/100.00;
                $(".rebate").html(rebate);                                                          //佣金支出百分比
                if(rebate!=0){
                    $(".rebate").parent().next('div').width(rebate+'%');
                }else{
                    $(".rebate").parent().next('div').addClass('none');
                }


                $("#payment").html(data.payment);                                                  //购物支出
                var payment=Math.round(data.payment/data.total_outcome * 10000)/100.00;
                $(".payment").html(payment);                                                    //购物支出百分比
                if(payment!=0){
                    $(".payment").parent().next('div').width(payment+'%');
                }else{
                    $(".payment").parent().next('div').addClass('none');
                }



                $("#cashier").html(data.cashier);                                                  //收款收入
                var cashier=Math.round(data.cashier/data.total_income * 10000)/100.00;
                $(".cashier").html(cashier);                                                     //收款收入百分比
                if(cashier!=0){
                    $(".cashier").parent().next('div').width(cashier+'%');
                }else{
                    $(".cashier").parent().next('div').addClass('none');
                }

                $("#outcome").html(data.outcome);                                                  //其他支出
                var outcome=Math.round(data.outcome/data.total_outcome * 10000)/100.00;
                $(".outcome").html(outcome);                                                    //其他支出百分比
                if(outcome!=0){
                    $(".outcome").parent().next('div').width(outcome+'%');
                }else{
                    $(".outcome").parent().next('div').addClass('none');
                }

                $("#income").html(data.income);                                                    //其他收入
                var income=Math.round(data.income/data.total_income * 10000)/100.00;
                $(".income").html(income);                                                          //其他收入百分比
                if(income!=0){
                    $(".income").parent().next('div').width(income+'%');
                }else{
                    $(".income").parent().next('div').addClass('none');
                }

                $("#recharge").html(data.recharge);                                                //充值收入
                var recharge=Math.round(data.recharge/data.total_income * 10000)/100.00;
                $(".recharge").html(recharge);                                                      //充值收入百分比
                if(recharge!=0){
                    $(".recharge").parent().next('div').width(recharge+'%');

                }else{
                    $(".recharge").parent().next('div').addClass('none');
                }

                $("#withdraw").html(data.withdraw);                                                //提现支出
                var withdraw=Math.round(data.withdraw/data.total_outcome * 10000)/100.00;
                $(".withdraw").html(withdraw);                                                      //提现支出百分比
                if(withdraw!=0){
                    $(".withdraw").parent().next('div').width(withdraw+'%');
                }else{
                    $(".withdraw").parent().next('div').addClass('none');
                }

                if(data.total_income==0){
                    $(".profit").html(0);
                    $(".profit").parent().next('div').addClass('none');
                    $(".receipts").html(0);
                    $(".receipts").parent().next('div').addClass('none');
                    $(".recharge").html(0);
                    $(".recharge").parent().next('div').addClass('none');
                    $(".income").html(0);
                    $(".income").parent().next('div').addClass('none');
                    $(".cashier").html(0);
                    $(".cashier").parent().next('div').addClass('none');
                }
                if(data.total_outcome==0){
                    $(".rebate").html(0);
                    $(".rebate").parent().next('div').addClass('none');
                    $(".payment").html(0);
                    $(".payment").parent().next('div').addClass('none');
                    $(".outcome").html(0);
                    $(".outcome").parent().next('div').addClass('none');
                    $(".withdraw").html(0);
                    $(".withdraw").parent().next('div').addClass('none');
                }
            });
            de.sumer({begin_date:nowdate});
            //打开日期选择控件
            $('#showDatePicker').on('click', function () {
                var year=date.getFullYear();
                var month=date.getMonth()+1;
                weui.datePicker({
                    start: 2015, //开始月份
                    end: new Date().getFullYear(),  //结束为当前年份
                    depth:2,
                    defaultValue: [year,month],
                    //日期选择时执行方法
                    onChange: function (result) {
                        //隐藏日的显示,只显示年月
                        $('.weui-picker__group').eq(2).css('display','none');
                    },
                    //日期确定后执行方法
                    onConfirm: function (result) {
                        $('#z1').html(result[0].value);     //选择时当前年份值
                        $('#z2').html(result[1].value);   //选择时当前月份值
                        //隐藏日的显示,只显示年月
                        $(".pageable .billdt").html('');
                        var z1=result[0].value;
                        var z2=result[1].value;
                        $('.purseBill .calender').css("display",'none');
                        var begin_date=z1+'-'+z2+'-1'+' '+'00:00:00';
                        var end_date = z1 + '-' + (z2 + 1) + '-1' + ' ' + '00:00:00';
                        //日期确定后，读取查询日期的账单统计
                        var de=new deposit(function(data){
                            $("#total_income").html(data.total_income);                                        //总收入
                            $("#total_outcome").html(data.total_outcome);                                      //总支出
                            $("#receipts").html(data.receipts);                                                //货款收入
                            var receipts=Math.round(data.receipts/data.total_income * 10000)/100.00;
                            $(".receipts").html(receipts);                                                      //货款收入百分比
                            if(receipts!=0){
                                $(".receipts").parent().next('div').width(receipts+'%');
                                $(".receipts").parent().next('div').removeClass('none');
                            }else{
                                $(".receipts").parent().next('div').addClass('none');
                            }

                            $("#profit").html(data.profit);                                                    //分润收入
                            var profit=Math.round(data.profit/data.total_income * 10000)/100.00;
                            $(".profit").html(profit);                                                          //分润收入百分比
                            if(profit!=0){
                                $(".profit").parent().next('div').width(profit+'%');
                                $(".profit").parent().next('div').removeClass('none');
                            }else{
                                $(".profit").parent().next('div').addClass('none');
                            }

                            $("#rebate").html(data.rebate);                                                    //佣金支出
                            var rebate=Math.round(data.rebate/data.total_outcome * 10000)/100.00;
                            $(".rebate").html(rebate);                                                          //佣金支出百分比
                            if(rebate!=0){
                                $(".rebate").parent().next('div').width(rebate+'%');
                                $(".rebate").parent().next('div').removeClass('none');
                            }else{
                                $(".rebate").parent().next('div').addClass('none');
                            }


                            $("#payment").html(data.payment);                                                  //购物支出
                            var payment=Math.round(data.payment/data.total_outcome * 10000)/100.00;
                            $(".payment").html(payment);                                                    //购物支出百分比
                            if(payment!=0){
                                $(".payment").parent().next('div').width(payment+'%');
                                $(".payment").parent().next('div').removeClass('none');
                            }else{
                                $(".payment").parent().next('div').addClass('none');
                            }



                            $("#cashier").html(data.cashier);                                                  //收款收入
                            var cashier=Math.round(data.cashier/data.total_income * 10000)/100.00;
                            $(".cashier").html(cashier);                                                     //收款收入百分比
                            if(cashier!=0){
                                $(".cashier").parent().next('div').width(cashier+'%');
                                $(".cashier").parent().next('div').removeClass('none');
                            }else{
                                $(".cashier").parent().next('div').addClass('none');
                            }

                            $("#outcome").html(data.outcome);                                                  //其他支出
                            var outcome=Math.round(data.outcome/data.total_outcome * 10000)/100.00;
                            $(".outcome").html(outcome);                                                    //其他支出百分比
                            if(outcome!=0){
                                $(".outcome").parent().next('div').width(outcome+'%');
                                $(".outcome").parent().next('div').removeClass('none');
                            }else{
                                $(".outcome").parent().next('div').addClass('none');
                            }

                            $("#income").html(data.income);                                                    //其他收入
                            var income=Math.round(data.income/data.total_income * 10000)/100.00;
                            $(".income").html(income);                                                          //其他收入百分比
                            if(income!=0){
                                $(".income").parent().next('div').width(income+'%');                                $(".income").parent().next('div').addClass('none');
                                $(".income").parent().next('div').removeClass('none');
                            }else{
                                $(".income").parent().next('div').addClass('none');
                            }

                            $("#recharge").html(data.recharge);                                                //充值收入
                            var recharge=Math.round(data.recharge/data.total_income * 10000)/100.00;
                            $(".recharge").html(recharge);                                                      //充值收入百分比
                            if(recharge!=0){
                                $(".recharge").parent().next('div').width(recharge+'%');
                                $(".recharge").parent().next('div').removeClass('none');

                            }else{
                                $(".recharge").parent().next('div').addClass('none');
                            }

                            $("#withdraw").html(data.withdraw);                                                //提现支出
                            var withdraw=Math.round(data.withdraw/data.total_outcome * 10000)/100.00;
                            $(".withdraw").html(withdraw);                                                      //提现支出百分比
                            if(withdraw!=0){
                                $(".withdraw").parent().next('div').width(withdraw+'%');
                                $(".withdraw").parent().next('div').removeClass('none');
                            }else{
                                $(".withdraw").parent().next('div').addClass('none');
                            }
                            if(data.total_income==0){
                                $(".profit").html(0);
                                $(".profit").parent().next('div').addClass('none');
                                $(".receipts").html(0);
                                $(".receipts").parent().next('div').addClass('none');
                                $(".recharge").html(0);
                                $(".recharge").parent().next('div').addClass('none');
                                $(".income").html(0);
                                $(".income").parent().next('div').addClass('none');
                                $(".cashier").html(0);
                                $(".cashier").parent().next('div').addClass('none');
                            }
                            if(data.total_outcome==0){
                                $(".rebate").html(0);
                                $(".rebate").parent().next('div').addClass('none');
                                $(".payment").html(0);
                                $(".payment").parent().next('div').addClass('none');
                                $(".outcome").html(0);
                                $(".outcome").parent().next('div').addClass('none');
                                $(".withdraw").html(0);
                                $(".withdraw").parent().next('div').addClass('none');
                            }
                        });
                        de.sumer({begin_date:begin_date,end_date:end_date});
                        //日期确定后，读取查询日期的账单明细
                        jsons={
                            begin_date:begin_date,
                            end_date:end_date,
                            pageNumber:1
                        };
                        pge2.refresh();
                        loadUpFn();
                    }
                });
                $('.weui-picker__group').eq(2).css('display','none');
            });
        }

        //申请成为合伙人
        if(window.location.hash=='#partnerProgram'){
            var countdown=60;
            function settime(val) {
                if (countdown == 0) {
                    val.removeAttribute("disabled");
                    val.value="获取";
                    val.style.background="#fff";
                    val.style.border='1px solid #333';
                    val.style.color="#333";
                    countdown = 60;
                    return;
                } else {
                    val.setAttribute("disabled", true);
                    val.value=countdown ;
                    val.style.background="#a5a5a5";
                    val.style.border=0;
                    val.style.color="#fff";
                    countdown--;
                }
                setTimeout(function() {
                    settime(val)
                },1000)
            }
            $(function () {
                var host = window.location.host;
                //域名为直通邦
                if(/www.ztbmall.com/gi.test(host)){
                    $('.partnerof').html('腻了吗');
                }else{
                    $('.partnerof').html('平台');
                }

                $('.step .understand').on('click',function () {
                    toast.show('暂未开通');
                });
                new member(function (data) {
                    if (data.bindMobile == "binded") {
                        $('.apply .phone').val(data.mobile);
                        $('.apply .phone').css('color','#333').css('opacity','1');
                    }else{
                        $('.apply .phone').removeAttr("disabled");
                    }
                }).view();

                $('.apply .gain').click(function(){
                    var $this=this;
                    var number=$('.apply .phone').val();
                    new partner(function (data) {
                        settime($this);
                    }).sendCode({mobile:number})

                });
                $(document).on('click','.sendapply',function () {
                    var phone=$('.apply .phone').val();
                    var captch=$('.apply .captcha').val();
                    var invite=$('.apply .invitecode').val();
                    var cc=new partner(function (data) {
                        $('#applying').html('等待客服与您取得联系');
                        $('#applying').css('background','#999');
                    });
                    cc.add({
                        captcha:captch,
                        inviteCode:invite,
                        mobile:phone
                    })
                })
            });
        }

        //合伙人招募
        if(window.location.hash=='#recruitPartner'){
            document.title='合伙人招募';

            new partner(function (data) {
                $('.recruitPartner .number').html(data.partnerCount);
//                $('.recruitPartner .amount').html(data.saleAmount);
//                $('.recruitPartner .profit').html(data.PerCapitaProfit);
            }).partnerInfo();

            //顶部轮播图片
            var ads = new ad(
                function (data) {
                    if(data.length > 0){
                        $("#index_slider").silderDot(data,1800,"","recruitPartner");
                    }
                }
            );
            ads.do(216);
            var countdown=60;
            function settime(val) {
                if($('#mobnum').val()!=""){
                    if (countdown == 0){
                        val.removeAttribute("disabled");
                        val.value="发送验证码";
                        val.style.background="#fff";
                        countdown = 60;
                        return;
                    } else {
                        val.setAttribute("disabled", true);
                        val.value="重新发送(" + countdown + ")";
                        val.style.background="#999";
                        countdown--;
                    }
                    setTimeout(function() {
                        settime(val)
                    },1000)
                }
            }
            //绑定手机获取验证码
            $("#getcap").click(function(){
                var mobilevalid = /^(0|86|17951)?(13[0-9]|15[012356789]|17[0-9]|18[0-9]|14[57])[0-9]{8}$/;
                var mobnum=$("#mobnum").val();
                if(mobnum==""){
                    toast.show("请输入手机号码");
                    return false;
                }else if(!mobilevalid.test(mobnum)){
                    dialog.show("请输入正确的手机号码！");
                    return false;
                } else{
                    var me=new member(function(data){
                        toast.show('已发送');
                    });
                    settime(this);
                    me.sendMobilePartner({mobile:mobnum})
                }
            });
            //立即开通
            $("#applyPartner").click(function(){
                var $this=$(this);
                var mobnum=$("#mobnum").val();
                var mobilevalid = /^(0|86|17951)?(13[0-9]|15[012356789]|17[0-9]|18[0-9]|14[0-9])[0-9]{8}$/;
                var capt=$("#captcha").val();
                if(!mobilevalid.test(mobnum)){
                    toast.show("请输入正确手机号码");
                    return false;
                }else if(capt==""){
                    toast.show("请输入验证码");
                    return false;
                }else{
                    $.ajax({
                        type: 'POST',
                        url: base+'weixin/member/register.jhtml',
                        data: {
                            username:mobnum,
                            captcha:capt
                        },
                        dataType: 'json',
                        context: $('body'),
                        crossDomain: true,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: function (data) {
                            if (data.message.type == "success") {
                                location.href='https://a.app.qq.com/o/simple.jsp?pkgname=com.tiaohuo.assistant';
                            } else {
                                if (data.message.type == "error" && data.message.content=='您已经申请过了') {
                                    dialog.show('您已经申请过了,快去下载店猫app吧！');
                                    setTimeout(function () {
                                        location.href='https://a.app.qq.com/o/simple.jsp?pkgname=com.tiaohuo.assistant';
                                    },2000)
                                } else {
                                    dialog.show(data.message.content);
                                }
                            }
                        },
                        error: function (xhr, type) {
                            toast.show("获取数据失败");
                        }
                    });
                }
            });



            new member(function (data) {
                weixin.share1({
                    title:data.title,
                    desc:data.des,
                    link:data.link,
                    imgUrl:data.image
                })
            }).partnerShare();
        }

        //邀请合伙人
        if(window.location.hash=='#invitePartner'){
            document.title='合伙人招募';
            //顶部轮播图片
            var ads = new ad(
                function (data) {
                    if(data.length > 0){
                        $("#index_slider").silderDot(data,1800,"","true");
                    }
                }
            );
            ads.do(217);
            var $iosMask2 = $('#iosMask2');
            function hideActionSheet2(){
                $iosMask2.fadeOut(200);
                $("#mcover2").css("display","none");
            }
            $iosMask2.on('click', hideActionSheet2);
            $('#mcover2').on('click',hideActionSheet2);
            new member(function (data) {
                var h = render.fill($("#tpl_partnerInfo"), data);
                $(".content").html(h);
            }).partnerView();
            new member(function (data) {
                $('.codeInvite').text(data.inviteCode);
            }).extension();
            new member(function (data) {
                weixin.share1({
                    title:data.title,
                    desc:data.des,
                    link:data.link,
                    imgUrl:data.image
                })
            }).partnerShare();
        }

        //实名认证
        if(window.location.hash=='#auth'){
            hiddenBtn.bind();
            //正面图片预览方法
            function getFullPath() {
                var file=document.getElementById('idcard1');
                var fileList = file.files;
                var img=document.getElementById("uploadimg1");
                for(var i=0;i<fileList.length;i++){
                    if(file.files[0]){
                        img.style.display = 'block';
                        img.style.width = '112px';
                        img.style.height = '80px';
                        if (window.createObjectURL!=undefined) { // basic
                            img.src = window.createObjectURL(file.files[0]);
                        } else if (window.URL!=undefined) { // mozilla(firefox)
                            img.src = window.URL.createObjectURL(file.files[0]);
                        } else if (window.webkitURL!=undefined) { // webkit or chrome
                            img.src = window.webkitURL.createObjectURL(file.files[0]);
                        }
                    }
                    var f_i= new FormData();
                    f_i.append("file",fileList[i])
                }
            }
            //反面图片预览方法
            function getFullPath2() {
                var file=document.getElementById('idcard2');
                var fileList = file.files;
                var img=document.getElementById("uploadimg2");
                for(var i=0;i<fileList.length;i++){
                    if(file.files[0]){
                        img.style.display = 'block';
                        img.style.width = '112px';
                        img.style.height = '80px';
                        if (window.createObjectURL!=undefined) { // basic
                            img.src = window.createObjectURL(file.files[0]);
                        } else if (window.URL!=undefined) { // mozilla(firefox)
                            img.src = window.URL.createObjectURL(file.files[0]);
                        } else if (window.webkitURL!=undefined) { // webkit or chrome
                            img.src = window.webkitURL.createObjectURL(file.files[0]);
                        }
                    }
                    var f_i= new FormData();
                    f_i.append("file",fileList[i])
                }
            }

            document.title='实名认证';
            var img1src;
            var img2src;
            $("#idcard1").on('change',function () {
                toast.loading2('上传中');
                $('#loadingToast').css('opacity',1);
                var fl = new file(function (data) {
                    getFullPath();
                    img1src=data;
//                    $('.certification #uploadimg1').attr('src',data);
                    $('#loadingToast').css('opacity',0);
                });
                fl.uploadImage(new FormData($("#idform1")[0]));
            });
            $("#idcard2").on('change',function () {
                toast.loading2('上传中');
                $('#loadingToast').css('opacity',1);
                var fl = new file(function (data) {
                    img2src=data;
                    getFullPath2();
                    $('#loadingToast').css('opacity',0);
//                    $('.certification #uploadimg2').attr('src',data);
                });
                fl.uploadImage(new FormData($("#idform2")[0]));
            });
            $("#sendcerti").on('click',function () {
                var name=$("#name").val();
                var idcard=$("#idcard").val();
                if(name==''){
                    toast.show('请输入姓名');
                }else if(!idcard.match(/^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/)){
                    toast.show('请正确输入身份证号');
                }else{
                    var me=new member(function(data){
                        dialog.show('提交成功，请耐心等待！');
                        setTimeout(function () {
                            pageManager.back();
                        },1000);
                    });
                    me.realNameAuthen({name:name,idcard:idcard,pathFront:img1src,pathBack:img2src});
                }
            })
        }

        //绑定手机
        if(window.location.hash=='#bind'){
            document.title='绑定手机';
            hiddenBtn.bind();

            var host = window.location.host;
            //域名为直通邦
            if(/www.ztbmall.com/gi.test(host)){
                $('.user_addphone .tiaohuo').html('腻了吗');
            }else{
                $('.user_addphone .tiaohuo').html('平台');
            }
            new member(function (data) {
                if(data.bindMobile=='binded'){
                    $('#mobnum').val(data.mobile);
                    $('#login').html('您已绑定');
                    $('#login').css('background','#999');
                    $("#getcap").css('background','#999');
                    $("#login").unbind('click');
                    $("#getcap").unbind('click');
                }
            }).view();
            var countdown=60;
            function settime(val) {
                if($('#mobnum').val()!=""){
                    if (countdown == 0) {
                        val.removeAttribute("disabled");
                        val.value="发送验证码";
                        val.style.background="#00a0e9";
                        countdown = 60;
                        return;
                    } else {
                        val.setAttribute("disabled", true);
                        val.value="重新发送(" + countdown + ")";
                        val.style.background="#999";
                        countdown--;
                    }
                    setTimeout(function() {
                        settime(val)
                    },1000)
                }
            }
            //绑定手机获取验证码
            $("#getcap").click(function(){
                var mobnum=$("#mobnum").val();
                if(mobnum==""){
                    toast.show("请输入手机号码");
                }else{
                    settime(this);
                    var me=new member(function(data){
                    });
                    me.sendCode({mobile:mobnum})
                }
            });
            //绑定手机
            $("#login").click(function(){
                var check=document.getElementById("weuiAgree");
                var mobnum=$("#mobnum").val();
                var capt=$("#captcha").val();
                var invite=$("#inviteCode").val();
                if(check.checked==true){
                    var me=new member(function(data){
                        toast.show("绑定成功");
                        setTimeout(function () {
                            if(pageManager.GetQueryString('type')=='password'){
                                location.replace('../payment/payPassword.html')
                            }else{
                                pageManager.back();
                            }
//                            window.location.href = document.referrer;
                        },1000);
                    });
                    me.bindMobile({mobile:mobnum,captcha:capt,inviteCode:invite});
                }else{
                    toast.show("请同意协议")
                }
            })
        }

        //订单列表
        if(pageManager._getHash()=='#orderList'){
            if(pageManager.GetQueryString('id')){
                var type = pageManager.GetQueryString('type');
                type = type?type:'all';
                var thistype=$('.'+type);
                thistype.next('p').show().siblings('p').hide();
                var jsonsData = {
                    pageSize: 10,
                    pageNumber: 1,
                    tenantId:pageManager.GetQueryString('id'),
                    type: type ? type : 'all'
                };
                var pge;
                var loadUpFn = function (type) {
                    if (type) jsonsData.type = type;
                    pge.refresh();
                    pageManager.replace('orderList?id='+ pageManager.GetQueryString('id')+'&type='+type)
//                    window.location.replace(location.origin+'/weixin/member/index.html?id='+ pageManager.GetQueryString('id') +'&type='+type+'#orderList');
                };
                $(document).on('click','.memberOrderGo',function () {
                    var thisTypeOrder=$(this).attr('otype');
                    loadUpFn(thisTypeOrder)
                });

                $(function () {
                    document.title='我的订单';
                    //切换加载数据
                    pge = $(".orderList .pageable").pageable({
                        loadUpFn: function (me) {
                            var tu = new order(function (data) {
                                jsonsData.pageNumber = jsonsData.pageNumber + 1;
                                var h = render.fill($("#tpl_list"), data);
                                $(".pageable .orderList").html(h);
                                pge.resetload();
                            });
                            jsonsData.pageNumber = 1;
                            tu.list(jsonsData);
                        },
                        loadDownFn: function (me) {
                            var td = new order(function (data) {
                                jsonsData.pageNumber = jsonsData.pageNumber + 1;
                                var h = render.fill($("#tpl_list"), data);
                                $(".pageable .orderList").append(h);
                                if (data.length < jsonsData.pageSize) {
                                    pge.lock();
                                    pge.noData();
                                }
                                pge.resetload();
                            });
                            td.list(jsonsData);
                        }
                    });
                    $('.vux-tab .vux-tab-item').on('click',function () {
                        $(this).next('p').show().siblings('p').hide();
                        var otype=$(this).attr('otype');
                    });
                });
            }else{
                var type = pageManager.GetQueryString('type');
                type = type?type:'all';
                var thistype=$('.'+type);
                thistype.next('p').show().siblings('p').hide();
                var jsonsData = {
                    pageSize: 10,
                    pageNumber: 1,
                    type: type ? type : 'all'
                };
                var pge;
                var loadUpFn = function (type) {
                    if (type) jsonsData.type = type;
//                    pge.refresh();
                    pageManager.replace('orderList?type='+type)
//                    window.location.replace(location.origin+'/weixin/member/index.html?type='+type+'#orderList');
                };

                $(document).on('click','.memberOrderGo',function () {
                    var thisTypeOrder=$(this).attr('otype');
                    loadUpFn(thisTypeOrder)
                });


                $(function () {
                    document.title='我的订单';
                    //切换加载数据
                    pge = $(".orderList .pageable").pageable({
                        loadUpFn: function (me) {
                            var tu = new order(function (data) {
                                jsonsData.pageNumber = jsonsData.pageNumber + 1;
                                var h = render.fill($("#tpl_list"), data);
                                $(".pageable .orderList").html(h);
                                pge.resetload();
                            });
                            jsonsData.pageNumber = 1;
                            tu.list(jsonsData);
                        },
                        loadDownFn: function (me) {
                            var td = new order(function (data) {
                                jsonsData.pageNumber = jsonsData.pageNumber + 1;
                                var h = render.fill($("#tpl_list"), data);
                                $(".pageable .orderList").append(h);
                                if (data.length < jsonsData.pageSize) {
                                    pge.lock();
                                    pge.noData();
                                }
                                pge.resetload();
                            });
                            td.list(jsonsData);
                        }
                    });
                    $('.vux-tab .vux-tab-item').on('click',function () {
                        $(this).next('p').show().siblings('p').hide();
                        var otype=$(this).attr('otype');
                    });
                });
            }

            $(function(){
                //查看物流显示第一个
                $('.logistics').each(function () {
                    var index=$(this).index();
                    if(index>1){
                        $(this).remove();
                    }
                });

                //取消订单
                $(document).on('click','.closeod',function () {
                    var $this=$(this);
                    var od_id;
                    od_id=$(this).parent().attr('order-id');
                    dialog.query("您确认取消该订单吗？",function(){
                        var or=new order(function(data){
                            console.log(data);
                            setTimeout(function () {
                                $this.parent().parent().remove();

                            },500);
                        });
                        or.refund({id:od_id})
                    });
                });


                //立即评价跳转
                $(document).on('click','.reviewod',function () {
                    var ev=$(this).parent().attr('order-id');
                    location.href=location.origin+'/weixin/member/index.html?id='+ev+'#orderEvaluate';
                });


                //提醒卖家发货
                $(document).on('click','.alertod',function () {
                    var od_id=$(this).parent().attr('order-id');
                    var or=new order(function(data){
                        console.log(data);
                        dialog.show("提醒成功")
                    });
                    or.remind({id:od_id})
                });


                //签收订单
                $(document).on('click','.signod',function () {
                    var $this=$(this);
                    var od_id;
                    od_id=$(this).parent().attr('order-id');
                    dialog.query("您确认签收该订单吗？",function () {
                        var or=new order(function(data){
                            console.log(data);
                            setTimeout(function () {
                                dialog.show("签收成功");

                                $this.parent().parent().remove();
                                location.reload();
                                location.href=location.origin+'/weixin/member/index.html?id='+od_id+'#orderEvaluate'
                            },500);
                        });
                        or.confirm({id:od_id})
                    })
                });

                //申请退货
                $(document).on('click','.backod',function () {
                    var od_id;
                    od_id=$(this).parent().attr('order-id');
                    dialog.query("您确认申请退货吗？",function () {
                        var or=new order(function(data){
                            console.log(data);
                            setTimeout(function () {
                                dialog.show("申请成功");
                                location.reload();

                            },500);
                        });
                        or.return({id:od_id});
                    })
                });


                //立即支付订单
                $(document).on('click','.payod',function () {
                    var order_id;
                    order_id=$(this).parent().attr('order-id');
                    var od=new order(function(data){
                        location.href=location.origin+'/weixin/payment/pay.html?sn='+data;
                    });
                    od.tradePayment({id:order_id});
                });

                //提醒商家退货
                $(document).on('click','.getmoneyod',function () {
                    var od_id=$(this).parent().attr('order-id');
                    var or=new order(function(data){
                        console.log(data);
                        dialog.show("提醒成功")
                    });
                    or.remind({id:od_id})
                })
            })
        }

        //订单详情
        if(window.location.hash=='#orderView'){
            document.title='订单详情';
            var od = new order(function (data) {
                var qcrode=data.pickUpCode;
                var src=base+'weixin/member/order/pickUpQrcode.jhtml?sn='+qcrode;
                $('#qCrode').attr('src',src);
                var h = render.fill($("#tpl_view"), data);
                $(".pageable .orderViewSwipper").html(h);
                $('#tihuocode').attr('src',src);
                $(document).on("click",".shangpin",function (){
                    var daid = $(this).attr('id');
                    if(data.orderItems[0].productId == null){
                        toast.show('此商品已删除！');
                    }else if(data.orderItems[0].marketable == false){
                        toast.show('此商品已下架！');
                    }else{
                        window.location.href="../product/view.html?id=" + daid;
                    }
                });

                $('.col-2').last().find('.line').remove();

//            订单的操作
                //取消订单
                $('.closeod').on('click',function () {
                    var od_id;
                    od_id=$(this).parent().attr('order-id');
                    dialog.query("您确认取消该订单吗？",function(){
                        var or=new order(function(data){
                            setTimeout(function () {
                                pageManager.back();
                            },1000);
                        });
                        or.refund({id:od_id})
                    });
                });

                $('.reviewod').on('click',function () {
                    var ev=$(this).parent().attr('order-id');
                    location.href=location.origin+'/weixin/member/index.html?id='+ev+'&hash='+(+new Date())+'#orderEvaluate';
                });
                //提醒卖家发货
                $('.alertod').on('click',function () {
                    var od_id=$(this).parent().attr('order-id');
                    var or=new order(function(data){
                        dialog.show("提醒成功");
                    });
                    or.remind({id:od_id})
                });
                //提醒卖家退款
                $('.getmoneyod').on('click',function () {
                    var od_id=$(this).parent().attr('order-id');
                    var or=new order(function(data){
                        dialog.show("提醒成功");
                    });
                    or.remind({id:od_id})
                });
                //签收订单
                $('.signod').on('click',function () {
                    var od_id;
                    od_id=$(this).parent().attr('order-id');
                    dialog.query("您确认签收该订单吗？",function () {
                        var or=new order(function(data){
                            toast.show("签收成功");
                            setTimeout(function () {
//                       pageManager.back();
                                location.href=location.origin+'/weixin/member/index.html?id='+od_id+'#orderEvaluate';
                            },1000);
                        });
                        or.confirm({id:od_id})
                    })
                });
                //申请退货
                $('.backod').on('click',function () {
                    var od_id;
                    od_id=$(this).parent().attr('order-id');
                    dialog.query("您确认申请退货吗？",function () {
                        var or=new order(function(data){
                            toast.show("申请成功");
                            setTimeout(function () {
                                pageManager.back();
                            },1000);
                        });
                        or.return({id:od_id});
                    })
                });
                //立即支付订单
                $('.payod').on('click',function () {
                    var order_id;
                    order_id=$(this).parent().attr('order-id');
                    var od=new order(function(data){
                        location.href=location.origin+'/weixin/payment/pay.html?sn='+data;
                    });
                    od.tradePayment({id:order_id});
                });
                //查看物流
                $('.logistics').on('click',function () {
                    var lssn=$('#trackingNo').html();
                    location.href=location.origin+'/weixin/member/logistics.html?sn='+lssn;
                });
                $('#Gcode .icon-orc').on('click',function () {
                    $("#iosMask").fadeIn();
                    $('.getcode').show();
                });

                //联系导购
                $(document).on('click','.chatwithGuide',function () {
                    var pid=$('.shangpin').eq(0).attr('id');
                    var tenantId=$(this).parent().attr('tenantId');
                    location.href='../product/view.html?ttid='+tenantId+'&prdtid='+pid+'#shopGuide';
                });

                var hostt = window.location.host;
                //域名为直通邦
                if(/www.ztbmall.com/gi.test(hostt)){
                    $('.discountType').html('腻了吗立减');
                }else{
                    $('.discountType').html('平台立减');
                }

            });
            od.view({id:pageManager.GetQueryString("id")});

        }

        //订单评价
        if(window.location.hash=='#orderEvaluate'){
            document.title='订单评价';
            var od = new review(function (data) {
                var h = render.fill($("#tpl_evaluate"), data);
                $(".orderEvaluate .pageable .orderEvaluteSwipper").html(h);

                //店铺评价与导购评价
                function star(starId){
                    var oStar = document.getElementById(starId);
                    var aLi = oStar.getElementsByTagName("i");
                    var oP = oStar.getElementsByTagName("input")[0];
                    var i = iScore = iStar = 0;
                    for (i = 1; i <= aLi.length; i++){
                        aLi[i - 1].index = i;
                        //点击后进行评分处理
                        aLi[i - 1].onclick = function (){
                            iStar = this.index;
                            fnPoint(iStar);
                            oP.value=iStar;
                        }
                    }
                    //评分处理
                    var fnPoint=function(iArg){
                        //分数赋值
                        iScore = iArg || iStar;
                        for (i = 0; i < aLi.length; i++) aLi[i].className = i < iScore ? "iconfont icon-s-star f14" : "iconfont icon-l-star f14";
                    };
                    fnPoint(5)
                }
                star("evaluatetenant"); //调用店铺评价星星的方法
                if(document.getElementById('evaluateguide')){
                    star("evaluateguide");  //调用导购星星评分的方法
                }

                //星星评分功能以及图片上传预览功能
                //点击评价晒单后弹出评论框
                var tmpl = '<li class="weui-uploader__file" style="background-image:url(#url#)"></li>';
                $(".toproduct").click(function(){
                    var oitemId=$(this).parent().attr("itemid");//当前商品项Id
                    ss("uploaderInput"+oitemId,"uploaderFiles"+oitemId); //input的id  ul的id
                    //宝贝星星评分方法
                    function starComm(starId){
                        var oStar = document.getElementById(starId);
                        var aLi = oStar.getElementsByTagName("i");
                        var oP = oStar.getElementsByTagName("input")[0];
                        var i = iScore = iStar = 0;
                        for (i = 1; i <= aLi.length; i++){
                            aLi[i - 1].index = i;
                            //点击后进行评分处理
                            aLi[i - 1].onclick = function (){
                                iStar = this.index;
                                fnPoint(iStar);
                                oP.value=iStar;
                            }
                        }
                        //评分处理
                        var fnPoint=function(iArg){
                            //分数赋值
                            iScore = iArg || iStar;
                            for (i = 0; i < aLi.length; i++) aLi[i].className = i < iScore ? "iconfont icon-s-star f14" : "iconfont icon-l-star f14";
                        };
                        fnPoint(5)
                    }
                    $(this).parent().parent().parent().next('div').fadeToggle();
                    var idid='evaluateproduct'+oitemId;
                    starComm(idid);      //调用星星评分方法
                    //本地上传图片并预览
                    function ss(a,b){
                        var $uploaderInput = $("#"+a);
                        var $uploaderFiles = $("#"+b);
                        $uploaderInput.click(function () {
                            var index=$(this).siblings().length;
                            $(this).parent().append('<input name="images['+index+'].file" class="weui-uploader__input uploaderInput" style="display: none;" type="file" accept="image/*" />');
                            $(this).parent().find("input").last().trigger("click");
                        });
                        //点击图片展示大图，再次点击关闭大图
                        $uploaderFiles.on("click", "li", function(){
                            var index=$(this).index();  //获取当前图片的下标
                            var gallery=$(this).parent().parent().parent().parent().parent().parent().prev('div');
                            var galleryImg=$(this).parent().parent().parent().parent().parent().parent().prev('div').find('span');
                            var delimg=$(this).parent().parent().parent().parent().parent().parent().prev('div').find('a');
                            //显示大图预览
                            galleryImg.attr("style", this.getAttribute("style"));
                            gallery.fadeIn(100);
                            //关闭大图预览
                            gallery.click(function () {
                                $(this).fadeOut(100);
                            });
//                    //买家删除当前照片
//                    delimg.click(function (){
//                        $(this).parent().parent().next('div').find('ul li').eq(index).remove();
//                    })
                            $('.weui-icon-delete').die().live('click',function(){
                                $(this).parent().parent().parent().next('div').find('ul li').eq(index).remove();
                                $(this).parent().parent().parent().next('div').find('.weui-uploader__input-box input').eq(index+1).remove();
                            })
                        });
                    }
                });
                $(document).on("change",".uploaderInput",function (e) {
                    var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
                    for (var i = 0, len = files.length; i < len; ++i) {
                        var file = files[i];
                        if (url) {
                            src = url.createObjectURL(file);
                        } else {
                            src = e.target.result;
                        }
                        $(this).parent().prev('ul').append($(tmpl.replace('#url#', src)));
                    }
                });
                //商品评论提交
                $('.sendproduct').click(function(){
                    var $this=$(this);
                    var orderItemId=$this.attr("orderItemId");                                                   //商品项id
                    var content=$this.parent().prev('div').prev('div').prev('form').find('textarea').val();     //宝贝评论内容
                    var score=parseInt($this.parent().prev().prev().prev().prev('div').find('input').val());    //商品评分
                    var flag="product";                                                                         //商品评论
                    var isAnonym;                                                                               //是否匿名
                    if($('#isAnonym').prop('checked')){
                        isAnonym=true;
                    }else{
                        isAnonym=false;
                    }
                    if(content==''){   //当用户不输入评论内容时，默认内容为好评
                        content='好评！'
                    };
                    var re=new review(function(data){
                        setTimeout(function (){
                            toast.show('你的评价提交成功');
                        },500);
                        $this.parent().parent().prev('div').find('.toproduct').addClass('clr_lightGray_border').html('已评价');
                        $this.parent().parent().css('display','none');
                    });
                    var jsons=new FormData($("#updateForm"+orderItemId)[0]);
                    jsons.append("orderItemId",orderItemId);
                    jsons.append("content",content);
                    jsons.append("score",score);
                    jsons.append("flag",flag);
                    jsons.append("isAnonym",isAnonym);
                    re.submit(jsons);
                });
                //订单评论
                $(".totenant").click(function(){
                    var $this=$(this);
                    var tradeId=pageManager.GetQueryString("id");      //子订单id
                    var point_tenant=parseInt($('#tenant').val());     //商家评分
                    var point_guide=parseInt($('#guide').val());       //导购评分
                    console.log(!isNaN(point_guide));
                    var r=new review(function(data){
                        console.log(data);
                        setTimeout(function (){
                            toast.show('您的评价提交成功');
                            $this.html('已评价');
                            $this.addClass('clr_lightGray_border');
                        },500);
                    });
                    var options={
                        tradeId:tradeId,
                        score:point_tenant,
                        flag:"trade"
                    };
                    if(!isNaN(point_guide)){
                        options.assistant=point_guide;
                    }
                    r.submit1(options);
                });
                //检测文本域的字数
                $("#content").keyup(function() {
                    $("#text_length").text($("#content").val().length);
                });

            });
            od.view({tradeId:pageManager.GetQueryString("id")});
        }

    };
    window.addEventListener('pageGoOk',pageFn)
</script>
</body>
</html>

